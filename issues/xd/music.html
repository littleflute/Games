<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简谱播放器 V0.16</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f5f5f5;
            touch-action: pan-y; /* 允许垂直滚动 */
        }
        
        .toolbar {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toolbar button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            min-height: 40px; /* 移动端友好的按钮大小 */
        }
        
        .toolbar button:hover {
            background-color: #2980b9;
        }
        
        .toolbar button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }
        
        .canvas-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background-color: white;
            -webkit-overflow-scrolling: touch; /* 移动端平滑滚动 */
        }
        
        .staff {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .paragraph {
            border: 3px solid #7b1fa2;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px;
            background-color: #f3e5f5;
            position: relative;
        }
        
        .paragraph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ce93d8;
        }
        
        .paragraph-title {
            font-weight: bold;
            font-size: 18px;
            color: #7b1fa2;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .paragraph-name-editable {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        
        .paragraph-name-editable:hover {
            background-color: rgba(255, 255, 255, 0.5);
            border-color: #ce93d8;
        }
        
        .paragraph-name-editable.editing {
            background-color: white;
            border-color: #3498db;
            cursor: text;
            outline: none;
        }
        
        .paragraph-actions {
            display: flex;
            gap: 5px;
        }
        
        .paragraph-actions button {
            background-color: #7b1fa2;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .paragraph-actions button:hover {
            background-color: #6a1b9a;
        }
        
        .paragraph.active {
            border-color: #2196f3;
            background-color: #e3f2fd;
        }
        
        .paragraph.highlighted {
            border-color: #ff9800;
            background-color: #fff9c4;
        }
        
        .paragraph-id {
            background-color: #7b1fa2;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 14px;
        }
        
        .measure {
            display: flex;
            border: 2px solid #333;
            border-radius: 5px;
            padding: 5px;
            background-color: #f9f9f9;
            position: relative;
            margin-top: 30px;
        }
        
        .measure.active {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        
        .measure.highlighted {
            background-color: #fff9c4;
            border-color: #ff9800;
        }
        
        .measure-number {
            position: absolute;
            top: -25px;
            left: 10px;
            font-weight: bold;
            color: #2c3e50;
            background-color: #fff;
            padding: 2px 8px;
            border-radius: 3px;
            border: 1px solid #ddd;
            font-size: 14px;
            z-index: 1;
        }
        
        .beat {
            flex: 1;
            height: 60px;
            border-right: 1px dashed #aaa;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .beat:last-child {
            border-right: none;
        }
        
        .beat.active {
            background-color: #bbdefb;
        }
        
        .beat-number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            color: #666;
        }
        
        .status-bar {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            text-align: center;
        }
        
        .settings-panel {
            position: fixed;
            top: 100px;
            left: 50px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 100;
            min-width: 300px;
            max-width: 90vw; /* 移动端适配 */
            max-height: 80vh; /* 移动端适配 */
            overflow: hidden;
        }
        
        .settings-header {
            background-color: #3498db;
            color: white;
            padding: 15px;
            border-radius: 5px 5px 0 0;
            cursor: move;
            user-select: none;
            position: relative;
            touch-action: none; /* 防止触摸时滚动 */
        }
        
        .settings-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .settings-header:hover {
            background-color: #2980b9;
        }
        
        .settings-tabs {
            display: flex;
            background-color: #ecf0f1;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
            text-align: center;
            color: #7f8c8d;
            min-height: 50px; /* 移动端友好的标签大小 */
        }
        
        .tab-btn.active {
            background-color: white;
            color: #3498db;
            font-weight: bold;
            border-bottom: 2px solid #3498db;
        }
        
        .tab-content {
            padding: 20px;
            max-height: 400px; /* 限制高度便于移动端显示 */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* 移动端平滑滚动 */
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        .settings-row {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* 移动端换行 */
        }
        
        .settings-row label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .settings-row select, .settings-row input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            flex: 1;
            min-width: 150px; /* 移动端最小宽度 */
        }
        
        .settings-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-left: 10px;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            color: white;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        .apply-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            min-height: 44px; /* 移动端友好的按钮大小 */
        }
        
        .apply-btn:hover {
            background-color: #219653;
        }
        
        .note-display {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 12px;
            color: #666;
            background-color: rgba(255,255,255,0.8);
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        /* 乐谱管理样式 */
        .paragraph-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap; /* 移动端换行 */
            gap: 5px;
        }
        
        .paragraph-controls button {
            background-color: #7b1fa2;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            min-height: 40px; /* 移动端友好的按钮大小 */
            flex: 1;
            min-width: 100px;
        }
        
        .paragraph-controls button:hover {
            background-color: #6a1b9a;
        }
        
        .paragraph-controls button.delete-btn {
            background-color: #e74c3c;
        }
        
        .paragraph-controls button.delete-btn:hover {
            background-color: #c0392b;
        }
        
        .paragraph-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .paragraph-btn {
            background-color: #e1bee7;
            border: 2px solid #ce93d8;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            min-width: 80px;
            text-align: center;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .paragraph-btn:hover {
            background-color: #d1c4e9;
        }
        
        .paragraph-btn.active {
            background-color: #7b1fa2;
            color: white;
            border-color: #6a1b9a;
        }
        
        .paragraph-btn-info {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }
        
        .measure-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap; /* 移动端换行 */
            gap: 5px;
        }
        
        .measure-controls button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            min-height: 40px; /* 移动端友好的按钮大小 */
            flex: 1;
            min-width: 100px;
        }
        
        .measure-controls button:hover {
            background-color: #2980b9;
        }
        
        .measure-controls button.delete-btn {
            background-color: #e74c3c;
        }
        
        .measure-controls button.delete-btn:hover {
            background-color: #c0392b;
        }
        
        .measure-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .measure-btn {
            background-color: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            min-width: 60px;
            text-align: center;
            font-weight: bold;
        }
        
        .measure-btn:hover {
            background-color: #d5dbdb;
        }
        
        .measure-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .paragraph-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .measure-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
            width: 100%;
        }
        
        /* 数据管理样式 */
        .data-management {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .json-display {
            width: 100%;
            height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            background-color: #f8f9fa;
        }
        
        .data-controls {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            flex-wrap: wrap; /* 移动端换行 */
        }
        
        .data-controls button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-height: 44px; /* 移动端友好的按钮大小 */
            min-width: 120px;
        }
        
        .export-btn {
            background-color: #27ae60;
            color: white;
        }
        
        .export-btn:hover {
            background-color: #219653;
        }
        
        .import-btn {
            background-color: #3498db;
            color: white;
        }
        
        .import-btn:hover {
            background-color: #2980b9;
        }
        
        .apply-json-btn {
            background-color: #f39c12;
            color: white;
        }
        
        .apply-json-btn:hover {
            background-color: #e67e22;
        }
        
        .file-input {
            display: none;
        }
        
        .status-message {
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 12px;
            text-align: center;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .toolbar {
                padding: 5px;
            }
            
            .toolbar button {
                padding: 6px 10px;
                font-size: 14px;
                margin: 0 2px;
            }
            
            .canvas-container {
                padding: 10px;
            }
            
            .settings-panel {
                top: 50px;
                left: 5%;
                right: 5%;
                width: 90%;
                max-width: none;
            }
            
            .settings-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .settings-row label {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .settings-row select, .settings-row input {
                width: 100%;
            }
            
            .paragraph-controls, .measure-controls, .data-controls {
                flex-direction: column;
            }
            
            .paragraph-controls button, .measure-controls button, .data-controls button {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .paragraph-name-editable {
                min-width: 80px;
                font-size: 16px; /* 移动端增大字体 */
            }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div>
            <button id="playBtn">播放</button>
            <button id="stopBtn" disabled>停止</button>
        </div>
        <button id="settingsBtn">设置</button>
    </div>
    
    <div class="canvas-container">
        <div class="staff" id="staff">
            <!-- 段落和小节将通过JavaScript动态生成 -->
        </div>
    </div>
    
    <div class="status-bar" id="statusBar">
        准备就绪 (V0.16)
    </div>
    
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header" id="settingsHeader">
            <h3>乐谱播放器设置 (V0.16 - 段落名称编辑)</h3>
            <button class="close-btn" id="closeSettingsBtn">×</button>
        </div>
        
        <div class="settings-tabs">
            <button class="tab-btn active" data-tab="playback">播放设置</button>
            <button class="tab-btn" data-tab="paragraph">段落管理</button>
            <button class="tab-btn" data-tab="score">小节管理</button>
            <button class="tab-btn" data-tab="data">数据管理</button>
        </div>
        
        <div class="tab-content">
            <!-- 播放设置标签页 -->
            <div class="tab-pane active" id="playback-tab">
                <div class="settings-row">
                    <label for="timeSignature">节拍类型:</label>
                    <select id="timeSignature">
                        <option value="4/4">4/4 拍</option>
                        <option value="3/4">3/4 拍</option>
                        <option value="2/4">2/4 拍</option>
                        <option value="6/8">6/8 拍</option>
                    </select>
                </div>
                
                <div class="settings-row">
                    <label for="tempo">速度 (BPM):</label>
                    <input type="number" id="tempo" min="40" max="200" value="120">
                </div>
                
                <div class="settings-row">
                    <label for="loopPlayback">循环播放:</label>
                    <input type="checkbox" id="loopPlayback" checked>
                    <span style="margin-left: 8px; font-size: 14px; color: #666;">播放结束后从头开始</span>
                </div>
                
                <button class="apply-btn" id="applySettingsBtn">应用设置</button>
            </div>
            
            <!-- 段落管理标签页 -->
            <div class="tab-pane" id="paragraph-tab">
                <div class="paragraph-controls">
                    <button id="addParagraphBtn">新建段落</button>
                    <button id="copyParagraphBtn" disabled>复制段落</button>
                    <button id="deleteParagraphBtn" class="delete-btn" disabled>删除段落</button>
                </div>
                
                <div class="paragraph-buttons-container" id="paragraphButtonsContainer">
                    <!-- 段落按钮将在这里动态生成 -->
                </div>
                
                <div class="paragraph-info">
                    <p>提示: 点击段落按钮可以选中该段落，然后可以对其进行复制、删除操作。</p>
                    <p>当前乐谱包含 <span id="paragraphCountDisplay">0</span> 个段落，共 <span id="totalMeasureCountDisplay">0</span> 个小节。</p>
                </div>
            </div>
            
            <!-- 小节管理标签页 -->
            <div class="tab-pane" id="score-tab">
                <div class="measure-controls">
                    <button id="addMeasureBtn">添加小节</button>
                    <button id="deleteMeasureBtn" class="delete-btn" disabled>删除选中小节</button>
                </div>
                
                <div class="paragraph-info">
                    <p>当前选中的段落: <span id="currentParagraphDisplay">无</span></p>
                    <p>提示: 只有在段落管理标签页中选中了一个段落后，才能在此添加或删除该段落内的小节。</p>
                </div>
                
                <div class="measure-buttons-container" id="measureButtonsContainer">
                    <!-- 小节按钮将在这里动态生成 -->
                </div>
                
                <div class="measure-info">
                    <p>当前段落包含 <span id="measureCountDisplay">0</span> 个小节。</p>
                </div>
            </div>
            
            <!-- 数据管理标签页 -->
            <div class="tab-pane" id="data-tab">
                <div class="data-management">
                    <textarea class="json-display" id="jsonDisplay" placeholder="乐谱数据将在这里显示..." readonly></textarea>
                    
                    <div class="data-controls">
                        <button class="export-btn" id="exportBtn">导出为JSON文件</button>
                        <button class="import-btn" id="importBtn">导入JSON文件</button>
                        <button class="apply-json-btn" id="applyJsonBtn">应用JSON数据</button>
                    </div>
                    
                    <input type="file" id="fileInput" class="file-input" accept=".json">
                    
                    <div id="statusMessage" class="status-message"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 乐谱播放器类 - V0.16 (段落名称编辑功能)
        class ScorePlayer {
            constructor() {
                this.isPlaying = false;
                this.currentParagraph = 0;
                this.currentMeasure = 0;
                this.currentBeat = 0;
                this.timer = null;
                this.timeSignature = '4/4';
                this.tempo = 120;
                this.loopPlayback = true;
                this.selectedParagraphIndex = null;
                this.selectedMeasureIndex = null;
                this.paragraphsData = [];
                this.isDragging = false;
                this.dragStartX = 0;
                this.dragStartY = 0;
                this.panelStartX = 0;
                this.panelStartY = 0;
                this.editingParagraphIndex = null; // 当前正在编辑的段落索引
                
                // 初始化段落ID计数器
                this.nextParagraphId = 1;
                
                // DOM元素引用
                this.domElements = {
                    playBtn: document.getElementById('playBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    settingsBtn: document.getElementById('settingsBtn'),
                    closeSettingsBtn: document.getElementById('closeSettingsBtn'),
                    applySettingsBtn: document.getElementById('applySettingsBtn'),
                    staff: document.getElementById('staff'),
                    statusBar: document.getElementById('statusBar'),
                    settingsPanel: document.getElementById('settingsPanel'),
                    settingsHeader: document.getElementById('settingsHeader'),
                    canvasContainer: document.querySelector('.canvas-container'),
                    timeSignature: document.getElementById('timeSignature'),
                    tempo: document.getElementById('tempo'),
                    loopPlayback: document.getElementById('loopPlayback'),
                    tabBtns: document.querySelectorAll('.tab-btn'),
                    // 段落管理相关元素
                    addParagraphBtn: document.getElementById('addParagraphBtn'),
                    copyParagraphBtn: document.getElementById('copyParagraphBtn'),
                    deleteParagraphBtn: document.getElementById('deleteParagraphBtn'),
                    paragraphButtonsContainer: document.getElementById('paragraphButtonsContainer'),
                    paragraphCountDisplay: document.getElementById('paragraphCountDisplay'),
                    totalMeasureCountDisplay: document.getElementById('totalMeasureCountDisplay'),
                    // 小节管理相关元素
                    addMeasureBtn: document.getElementById('addMeasureBtn'),
                    deleteMeasureBtn: document.getElementById('deleteMeasureBtn'),
                    measureButtonsContainer: document.getElementById('measureButtonsContainer'),
                    measureCountDisplay: document.getElementById('measureCountDisplay'),
                    currentParagraphDisplay: document.getElementById('currentParagraphDisplay'),
                    // 数据管理相关元素
                    jsonDisplay: document.getElementById('jsonDisplay'),
                    exportBtn: document.getElementById('exportBtn'),
                    importBtn: document.getElementById('importBtn'),
                    applyJsonBtn: document.getElementById('applyJsonBtn'),
                    fileInput: document.getElementById('fileInput'),
                    statusMessage: document.getElementById('statusMessage')
                };
                
                this.init();
            }
            
            // 初始化播放器
            init() {
                this.initializeParagraphsData(2, 4);
                this.generateStaff();
                this.setupEventListeners();
                this.updateParagraphButtons();
                this.updateJsonDisplay();
            }
            
            // 初始化段落数据
            initializeParagraphsData(paragraphCount, measuresPerParagraph) {
                this.paragraphsData = [];
                for (let i = 0; i < paragraphCount; i++) {
                    const paragraph = {
                        id: this.nextParagraphId++,
                        name: `段落 ${i + 1}`,
                        measures: []
                    };
                    
                    for (let j = 0; j < measuresPerParagraph; j++) {
                        paragraph.measures.push(this.generateRandomNotes());
                    }
                    
                    this.paragraphsData.push(paragraph);
                }
            }
            
            // 生成随机音符数据
            generateRandomNotes() {
                const notes = ['1', '2', '3', '4', '5', '6', '7'];
                const [beatsPerMeasure] = this.timeSignature.split('/').map(Number);
                const measureNotes = [];
                
                for (let i = 0; i < beatsPerMeasure; i++) {
                    const randomNote = notes[Math.floor(Math.random() * notes.length)];
                    measureNotes.push(randomNote);
                }
                
                return measureNotes;
            }
            
            // 生成五线谱
            generateStaff() {
                this.domElements.staff.innerHTML = '';
                
                const [beatsPerMeasure] = this.timeSignature.split('/').map(Number);
                
                // 遍历所有段落
                for (let p = 0; p < this.paragraphsData.length; p++) {
                    const paragraph = this.paragraphsData[p];
                    
                    // 创建段落容器
                    const paragraphElement = document.createElement('div');
                    paragraphElement.className = 'paragraph';
                    paragraphElement.dataset.paragraphIndex = p;
                    
                    // 添加段落头部
                    const paragraphHeader = document.createElement('div');
                    paragraphHeader.className = 'paragraph-header';
                    
                    const paragraphTitle = document.createElement('div');
                    paragraphTitle.className = 'paragraph-title';
                    paragraphTitle.innerHTML = `
                        <span class="paragraph-id">段落 ${p + 1}</span>
                        <span class="paragraph-name-editable" data-paragraph-index="${p}">${paragraph.name}</span>
                    `;
                    
                    const paragraphActions = document.createElement('div');
                    paragraphActions.className = 'paragraph-actions';
                    
                    paragraphHeader.appendChild(paragraphTitle);
                    paragraphHeader.appendChild(paragraphActions);
                    paragraphElement.appendChild(paragraphHeader);
                    
                    // 遍历段落中的小节
                    for (let m = 0; m < paragraph.measures.length; m++) {
                        const measure = document.createElement('div');
                        measure.className = 'measure';
                        measure.dataset.paragraphIndex = p;
                        measure.dataset.measureIndex = m;
                        
                        // 添加小节序号
                        const measureNumber = document.createElement('div');
                        measureNumber.className = 'measure-number';
                        measureNumber.textContent = `段落 ${p + 1} - 小节 ${m + 1}`;
                        measure.appendChild(measureNumber);
                        
                        // 获取该小节的音符数据
                        const measureNotes = paragraph.measures[m];
                        
                        // 添加拍子
                        for (let b = 0; b < beatsPerMeasure; b++) {
                            const beat = document.createElement('div');
                            beat.className = 'beat';
                            beat.dataset.beatIndex = b;
                            
                            const beatNumber = document.createElement('span');
                            beatNumber.className = 'beat-number';
                            beatNumber.textContent = b + 1;
                            
                            beat.appendChild(beatNumber);
                            
                            // 添加音符显示
                            const noteDisplay = document.createElement('span');
                            noteDisplay.className = 'note-display';
                            
                            // 显示对应的音符
                            const note = measureNotes[b] || '0';
                            noteDisplay.textContent = note;
                            
                            beat.appendChild(noteDisplay);
                            measure.appendChild(beat);
                        }
                        
                        paragraphElement.appendChild(measure);
                    }
                    
                    this.domElements.staff.appendChild(paragraphElement);
                }
            }
            
            // 更新段落按钮
            updateParagraphButtons() {
                this.domElements.paragraphButtonsContainer.innerHTML = '';
                
                if (this.paragraphsData.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.textContent = '当前乐谱没有段落，点击"新建段落"按钮开始创建。';
                    this.domElements.paragraphButtonsContainer.appendChild(emptyState);
                    this.domElements.copyParagraphBtn.disabled = true;
                    this.domElements.deleteParagraphBtn.disabled = true;
                } else {
                    for (let i = 0; i < this.paragraphsData.length; i++) {
                        const paragraph = this.paragraphsData[i];
                        const paragraphBtn = document.createElement('button');
                        paragraphBtn.className = 'paragraph-btn';
                        if (i === this.selectedParagraphIndex) {
                            paragraphBtn.classList.add('active');
                        }
                        paragraphBtn.textContent = paragraph.name;
                        
                        const infoSpan = document.createElement('span');
                        infoSpan.className = 'paragraph-btn-info';
                        infoSpan.textContent = `${paragraph.measures.length} 小节`;
                        
                        paragraphBtn.appendChild(infoSpan);
                        paragraphBtn.dataset.paragraphIndex = i;
                        
                        paragraphBtn.addEventListener('click', () => {
                            this.selectParagraph(i);
                            this.highlightParagraph(i);
                        });
                        
                        this.domElements.paragraphButtonsContainer.appendChild(paragraphBtn);
                    }
                    
                    this.domElements.copyParagraphBtn.disabled = this.selectedParagraphIndex === null;
                    this.domElements.deleteParagraphBtn.disabled = this.selectedParagraphIndex === null;
                }
                
                this.domElements.paragraphCountDisplay.textContent = this.paragraphsData.length;
                
                // 计算总小节数
                let totalMeasures = 0;
                for (const paragraph of this.paragraphsData) {
                    totalMeasures += paragraph.measures.length;
                }
                this.domElements.totalMeasureCountDisplay.textContent = totalMeasures;
                
                // 更新小节管理标签页
                this.updateMeasureButtons();
            }
            
            // 更新小节按钮
            updateMeasureButtons() {
                this.domElements.measureButtonsContainer.innerHTML = '';
                
                // 更新当前选中的段落显示
                if (this.selectedParagraphIndex !== null) {
                    const paragraph = this.paragraphsData[this.selectedParagraphIndex];
                    this.domElements.currentParagraphDisplay.textContent = paragraph.name;
                } else {
                    this.domElements.currentParagraphDisplay.textContent = '无';
                    this.domElements.addMeasureBtn.disabled = true;
                    this.domElements.deleteMeasureBtn.disabled = true;
                    return;
                }
                
                this.domElements.addMeasureBtn.disabled = false;
                
                const paragraph = this.paragraphsData[this.selectedParagraphIndex];
                
                if (paragraph.measures.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.textContent = '当前段落没有小节，点击"添加小节"按钮开始创建。';
                    this.domElements.measureButtonsContainer.appendChild(emptyState);
                    this.domElements.deleteMeasureBtn.disabled = true;
                } else {
                    for (let i = 0; i < paragraph.measures.length; i++) {
                        const measureBtn = document.createElement('button');
                        measureBtn.className = 'measure-btn';
                        if (i === this.selectedMeasureIndex) {
                            measureBtn.classList.add('active');
                        }
                        measureBtn.textContent = `小节 ${i + 1}`;
                        measureBtn.dataset.measureIndex = i;
                        
                        measureBtn.addEventListener('click', () => {
                            this.selectMeasure(i);
                            this.highlightMeasure(this.selectedParagraphIndex, i);
                        });
                        
                        this.domElements.measureButtonsContainer.appendChild(measureBtn);
                    }
                    
                    this.domElements.deleteMeasureBtn.disabled = this.selectedMeasureIndex === null;
                }
                
                this.domElements.measureCountDisplay.textContent = paragraph.measures.length;
            }
            
            // 更新JSON数据显示
            updateJsonDisplay() {
                const scoreData = {
                    version: "0.16",
                    timeSignature: this.timeSignature,
                    tempo: this.tempo,
                    loopPlayback: this.loopPlayback,
                    paragraphs: this.paragraphsData,
                    lastUpdated: new Date().toISOString()
                };
                
                this.domElements.jsonDisplay.value = JSON.stringify(scoreData, null, 2);
            }
            
            // 导出为JSON文件
            exportToJson() {
                this.updateJsonDisplay();
                const dataStr = this.domElements.jsonDisplay.value;
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `score_data_v0.16_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                this.showStatusMessage('数据导出成功！', 'success');
            }
            
            // 导入JSON文件
            importFromJson() {
                this.domElements.fileInput.click();
            }
            
            // 处理文件导入
            handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        this.applyJsonData(jsonData);
                        this.showStatusMessage('数据导入成功！', 'success');
                    } catch (error) {
                        this.showStatusMessage('文件格式错误，请导入有效的JSON文件', 'error');
                        console.error('JSON解析错误:', error);
                    }
                };
                reader.readAsText(file);
                
                // 重置文件输入，允许重复选择同一文件
                event.target.value = '';
            }
            
            // 应用JSON数据
            applyJsonData(jsonData) {
                if (jsonData.version && jsonData.paragraphs) {
                    this.timeSignature = jsonData.timeSignature || this.timeSignature;
                    this.tempo = jsonData.tempo || this.tempo;
                    this.loopPlayback = jsonData.loopPlayback !== undefined ? jsonData.loopPlayback : this.loopPlayback;
                    this.paragraphsData = jsonData.paragraphs;
                    
                    // 更新下一个段落ID
                    let maxId = 0;
                    for (const paragraph of this.paragraphsData) {
                        if (paragraph.id > maxId) maxId = paragraph.id;
                    }
                    this.nextParagraphId = maxId + 1;
                    
                    // 更新UI
                    this.domElements.timeSignature.value = this.timeSignature;
                    this.domElements.tempo.value = this.tempo;
                    this.domElements.loopPlayback.checked = this.loopPlayback;
                    
                    this.generateStaff();
                    this.selectedParagraphIndex = null;
                    this.selectedMeasureIndex = null;
                    this.updateParagraphButtons();
                    this.updateJsonDisplay();
                    this.stopPlayback();
                    this.resetPlayback();
                    
                    this.showStatusMessage('JSON数据应用成功！', 'success');
                } else {
                    this.showStatusMessage('无效的乐谱数据格式', 'error');
                }
            }
            
            // 显示状态消息
            showStatusMessage(message, type) {
                const statusElement = this.domElements.statusMessage;
                statusElement.textContent = message;
                statusElement.className = `status-message status-${type}`;
                
                setTimeout(() => {
                    statusElement.textContent = '';
                    statusElement.className = 'status-message';
                }, 3000);
            }
            
            // 选择段落
            selectParagraph(index) {
                this.selectedParagraphIndex = index;
                this.selectedMeasureIndex = null;
                this.updateParagraphButtons();
            }
            
            // 选择小节
            selectMeasure(index) {
                this.selectedMeasureIndex = index;
                this.updateMeasureButtons();
            }
            
            // 高亮显示指定段落
            highlightParagraph(index) {
                document.querySelectorAll('.paragraph.highlighted').forEach(el => {
                    el.classList.remove('highlighted');
                });
                
                const paragraph = document.querySelector(`.paragraph[data-paragraph-index="${index}"]`);
                if (paragraph) {
                    paragraph.classList.add('highlighted');
                    this.scrollToParagraph(index);
                }
            }
            
            // 高亮显示指定小节
            highlightMeasure(paragraphIndex, measureIndex) {
                document.querySelectorAll('.measure.highlighted').forEach(el => {
                    el.classList.remove('highlighted');
                });
                
                const measure = document.querySelector(`.measure[data-paragraph-index="${paragraphIndex}"][data-measure-index="${measureIndex}"]`);
                if (measure) {
                    measure.classList.add('highlighted');
                    this.scrollToMeasure(paragraphIndex, measureIndex);
                }
            }
            
            // 滚动到指定段落
            scrollToParagraph(index) {
                const paragraphElement = document.querySelector(`.paragraph[data-paragraph-index="${index}"]`);
                if (paragraphElement) {
                    const container = this.domElements.canvasContainer;
                    const containerHeight = container.clientHeight;
                    const elementTop = paragraphElement.offsetTop;
                    const elementHeight = paragraphElement.offsetHeight;
                    
                    const targetScrollTop = elementTop - (containerHeight / 2) + (elementHeight / 2);
                    
                    container.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                }
            }
            
            // 滚动到指定小节
            scrollToMeasure(paragraphIndex, measureIndex) {
                const measureElement = document.querySelector(`.measure[data-paragraph-index="${paragraphIndex}"][data-measure-index="${measureIndex}"]`);
                if (measureElement) {
                    const container = this.domElements.canvasContainer;
                    const containerHeight = container.clientHeight;
                    const elementTop = measureElement.offsetTop;
                    const elementHeight = measureElement.offsetHeight;
                    
                    const targetScrollTop = elementTop - (containerHeight / 2) + (elementHeight / 2);
                    
                    container.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                }
            }
            
            // 添加段落
            addParagraph() {
                const newParagraph = {
                    id: this.nextParagraphId++,
                    name: `段落 ${this.paragraphsData.length + 1}`,
                    measures: []
                };
                
                // 为新段落添加初始小节
                const [beatsPerMeasure] = this.timeSignature.split('/').map(Number);
                for (let i = 0; i < 4; i++) {
                    newParagraph.measures.push(this.generateRandomNotes());
                }
                
                this.paragraphsData.push(newParagraph);
                this.generateStaff();
                this.updateParagraphButtons();
                this.updateJsonDisplay();
                
                this.selectParagraph(this.paragraphsData.length - 1);
                this.highlightParagraph(this.paragraphsData.length - 1);
            }
            
            // 复制段落
            copyParagraph() {
                if (this.selectedParagraphIndex === null) return;
                
                const originalParagraph = this.paragraphsData[this.selectedParagraphIndex];
                
                // 深度复制段落
                const copiedParagraph = {
                    id: this.nextParagraphId++,
                    name: `${originalParagraph.name} (副本)`,
                    measures: JSON.parse(JSON.stringify(originalParagraph.measures))
                };
                
                this.paragraphsData.splice(this.selectedParagraphIndex + 1, 0, copiedParagraph);
                this.generateStaff();
                this.updateParagraphButtons();
                this.updateJsonDisplay();
                
                this.selectParagraph(this.selectedParagraphIndex + 1);
                this.highlightParagraph(this.selectedParagraphIndex);
            }
            
            // 删除选中段落
            deleteSelectedParagraph() {
                if (this.selectedParagraphIndex === null || this.paragraphsData.length <= 1) return;
                
                this.paragraphsData.splice(this.selectedParagraphIndex, 1);
                this.selectedParagraphIndex = null;
                this.selectedMeasureIndex = null;
                
                this.generateStaff();
                this.updateParagraphButtons();
                this.updateJsonDisplay();
                
                if (this.isPlaying && this.currentParagraph >= this.paragraphsData.length) {
                    this.currentParagraph = Math.max(0, this.paragraphsData.length - 1);
                    this.currentMeasure = 0;
                    this.currentBeat = 0;
                }
            }
            
            // 添加小节
            addMeasure() {
                if (this.selectedParagraphIndex === null) return;
                
                const paragraph = this.paragraphsData[this.selectedParagraphIndex];
                const newMeasureNotes = this.generateRandomNotes();
                paragraph.measures.push(newMeasureNotes);
                
                this.generateStaff();
                this.updateParagraphButtons();
                this.updateMeasureButtons();
                this.updateJsonDisplay();
                
                this.selectMeasure(paragraph.measures.length - 1);
                this.highlightMeasure(this.selectedParagraphIndex, paragraph.measures.length - 1);
            }
            
            // 删除选中小节
            deleteSelectedMeasure() {
                if (this.selectedParagraphIndex === null || this.selectedMeasureIndex === null) return;
                
                const paragraph = this.paragraphsData[this.selectedParagraphIndex];
                if (paragraph.measures.length <= 1) return;
                
                paragraph.measures.splice(this.selectedMeasureIndex, 1);
                this.selectedMeasureIndex = null;
                
                this.generateStaff();
                this.updateParagraphButtons();
                this.updateMeasureButtons();
                this.updateJsonDisplay();
                
                // 如果正在播放，调整播放位置
                if (this.isPlaying && 
                    this.currentParagraph === this.selectedParagraphIndex && 
                    this.currentMeasure >= paragraph.measures.length) {
                    this.currentMeasure = Math.max(0, paragraph.measures.length - 1);
                    this.currentBeat = 0;
                }
            }
            
            // 滚动到当前段落
            scrollToCurrentParagraph() {
                const currentParagraphElement = document.querySelector(`.paragraph[data-paragraph-index="${this.currentParagraph}"]`);
                if (currentParagraphElement) {
                    const container = this.domElements.canvasContainer;
                    const containerHeight = container.clientHeight;
                    const elementTop = currentParagraphElement.offsetTop;
                    const elementHeight = currentParagraphElement.offsetHeight;
                    
                    const targetScrollTop = elementTop - (containerHeight / 2) + (elementHeight / 2);
                    
                    container.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                }
            }
            
            // 播放动画
            playAnimation() {
                const [beatsPerMeasure] = this.timeSignature.split('/').map(Number);
                const beatDuration = 60000 / this.tempo;
                
                // 清除所有活动状态
                document.querySelectorAll('.paragraph.active, .measure.active, .beat.active').forEach(el => {
                    el.classList.remove('active');
                });
                
                // 检查是否还有段落
                if (this.currentParagraph >= this.paragraphsData.length) {
                    if (this.loopPlayback) {
                        this.currentParagraph = 0;
                        this.currentMeasure = 0;
                        this.currentBeat = 0;
                    } else {
                        this.stopPlayback();
                        this.domElements.statusBar.textContent = `播放完成 (V0.16)`;
                        return;
                    }
                }
                
                const currentParagraph = this.paragraphsData[this.currentParagraph];
                
                // 检查是否还有小节
                if (this.currentMeasure >= currentParagraph.measures.length) {
                    this.currentParagraph++;
                    this.currentMeasure = 0;
                    this.currentBeat = 0;
                    
                    if (this.currentParagraph >= this.paragraphsData.length) {
                        if (this.loopPlayback) {
                            this.currentParagraph = 0;
                        } else {
                            this.stopPlayback();
                            this.domElements.statusBar.textContent = `播放完成 (V0.16)`;
                            return;
                        }
                    }
                }
                
                // 高亮当前段落
                const paragraphElement = document.querySelector(`.paragraph[data-paragraph-index="${this.currentParagraph}"]`);
                if (paragraphElement) {
                    paragraphElement.classList.add('active');
                }
                
                // 高亮当前小节
                const measureElement = document.querySelector(`.measure[data-paragraph-index="${this.currentParagraph}"][data-measure-index="${this.currentMeasure}"]`);
                if (measureElement) {
                    measureElement.classList.add('active');
                    
                    // 高亮当前拍子
                    const beats = measureElement.querySelectorAll('.beat');
                    if (this.currentBeat < beats.length) {
                        beats[this.currentBeat].classList.add('active');
                    }
                }
                
                this.domElements.statusBar.textContent = `当前: ${currentParagraph.name} - 第 ${this.currentMeasure + 1} 小节 - 第 ${this.currentBeat + 1} 拍 (V0.16)`;
                
                if (this.currentBeat === 0 && this.currentMeasure === 0) {
                    this.scrollToCurrentParagraph();
                }
                
                this.currentBeat++;
                if (this.currentBeat >= beatsPerMeasure) {
                    this.currentBeat = 0;
                    this.currentMeasure++;
                }
                
                this.timer = setTimeout(() => this.playAnimation(), beatDuration);
            }
            
            // 开始播放
            startPlayback() {
                if (this.isPlaying) return;
                
                this.isPlaying = true;
                this.domElements.playBtn.disabled = true;
                this.domElements.stopBtn.disabled = false;
                
                if (this.currentParagraph === 0 && this.currentMeasure === 0 && this.currentBeat === 0) {
                    setTimeout(() => this.scrollToCurrentParagraph(), 50);
                }
                
                this.playAnimation();
            }
            
            // 停止播放
            stopPlayback() {
                if (!this.isPlaying) return;
                
                this.isPlaying = false;
                this.domElements.playBtn.disabled = false;
                this.domElements.stopBtn.disabled = true;
                
                clearTimeout(this.timer);
                
                document.querySelectorAll('.paragraph.active, .measure.active, .beat.active').forEach(el => {
                    el.classList.remove('active');
                });
                
                this.domElements.statusBar.textContent = '已停止 (V0.16)';
                this.currentParagraph = 0;
                this.currentMeasure = 0;
                this.currentBeat = 0;
            }
            
            // 应用设置
            applySettings() {
                this.timeSignature = this.domElements.timeSignature.value;
                this.tempo = parseInt(this.domElements.tempo.value);
                this.loopPlayback = this.domElements.loopPlayback.checked;
                
                const [beatsPerMeasure] = this.timeSignature.split('/').map(Number);
                
                // 更新所有段落中的所有小节
                for (let p = 0; p < this.paragraphsData.length; p++) {
                    const paragraph = this.paragraphsData[p];
                    for (let m = 0; m < paragraph.measures.length; m++) {
                        if (paragraph.measures[m].length !== beatsPerMeasure) {
                            paragraph.measures[m] = this.generateRandomNotes();
                        }
                    }
                }
                
                this.generateStaff();
                this.updateJsonDisplay();
                this.stopPlayback();
                this.resetPlayback();
                this.domElements.settingsPanel.style.display = 'none';
            }
            
            // 重置播放位置
            resetPlayback() {
                this.currentParagraph = 0;
                this.currentMeasure = 0;
                this.currentBeat = 0;
            }
            
            // 切换标签页
            switchTab(tabName) {
                this.domElements.tabBtns.forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    if (pane.id === `${tabName}-tab`) {
                        pane.classList.add('active');
                    } else {
                        pane.classList.remove('active');
                    }
                });
                
                // 切换到数据管理标签页时更新JSON显示
                if (tabName === 'data') {
                    this.updateJsonDisplay();
                }
            }
            
            // 段落名称编辑功能
            setupParagraphNameEditing() {
                // 点击段落名称进入编辑模式
                this.domElements.staff.addEventListener('click', (e) => {
                    if (e.target.classList.contains('paragraph-name-editable') && !e.target.classList.contains('editing')) {
                        this.startEditingParagraphName(e.target);
                    }
                });
                
                // 双击段落名称进入编辑模式
                this.domElements.staff.addEventListener('dblclick', (e) => {
                    if (e.target.classList.contains('paragraph-name-editable') && !e.target.classList.contains('editing')) {
                        this.startEditingParagraphName(e.target);
                    }
                });
                
                // 处理按键事件
                this.domElements.staff.addEventListener('keydown', (e) => {
                    if (e.target.classList.contains('paragraph-name-editable') && e.target.classList.contains('editing')) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.finishEditingParagraphName(e.target);
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            this.cancelEditingParagraphName(e.target);
                        }
                    }
                });
                
                // 失去焦点时保存
                this.domElements.staff.addEventListener('blur', (e) => {
                    if (e.target.classList.contains('paragraph-name-editable') && e.target.classList.contains('editing')) {
                        this.finishEditingParagraphName(e.target);
                    }
                }, true);
            }
            
            // 开始编辑段落名称
            startEditingParagraphName(element) {
                if (this.editingParagraphIndex !== null) {
                    // 如果已经有段落正在编辑，先保存
                    const currentEditingElement = document.querySelector(`.paragraph-name-editable[data-paragraph-index="${this.editingParagraphIndex}"]`);
                    if (currentEditingElement) {
                        this.finishEditingParagraphName(currentEditingElement);
                    }
                }
                
                const paragraphIndex = parseInt(element.dataset.paragraphIndex);
                this.editingParagraphIndex = paragraphIndex;
                
                element.classList.add('editing');
                element.setAttribute('contenteditable', 'true');
                element.focus();
                
                // 选中文本
                const range = document.createRange();
                range.selectNodeContents(element);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }
            
            // 完成编辑段落名称
            finishEditingParagraphName(element) {
                const paragraphIndex = parseInt(element.dataset.paragraphIndex);
                const newName = element.textContent.trim();
                
                if (newName && newName !== this.paragraphsData[paragraphIndex].name) {
                    this.paragraphsData[paragraphIndex].name = newName;
                    
                    // 更新段落按钮中的名称
                    const paragraphBtn = document.querySelector(`.paragraph-btn[data-paragraph-index="${paragraphIndex}"]`);
                    if (paragraphBtn) {
                        paragraphBtn.textContent = newName;
                        const infoSpan = document.createElement('span');
                        infoSpan.className = 'paragraph-btn-info';
                        infoSpan.textContent = `${this.paragraphsData[paragraphIndex].measures.length} 小节`;
                        paragraphBtn.appendChild(infoSpan);
                    }
                    
                    // 更新小节管理标签页中的段落名称显示
                    if (this.selectedParagraphIndex === paragraphIndex) {
                        this.domElements.currentParagraphDisplay.textContent = newName;
                    }
                    
                    this.updateJsonDisplay();
                }
                
                this.cancelEditingParagraphName(element);
            }
            
            // 取消编辑段落名称
            cancelEditingParagraphName(element) {
                const paragraphIndex = parseInt(element.dataset.paragraphIndex);
                element.textContent = this.paragraphsData[paragraphIndex].name;
                element.classList.remove('editing');
                element.removeAttribute('contenteditable');
                this.editingParagraphIndex = null;
                
                // 清除选中文本
                window.getSelection().removeAllRanges();
            }
            
            // 使设置面板可拖动（支持移动端触摸事件）
            makeDraggable(element, handle) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                
                // 鼠标事件处理
                handle.onmousedown = (e) => {
                    e = e || window.event;
                    e.preventDefault();
                    
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    
                    document.onmouseup = () => {
                        document.onmouseup = null;
                        document.onmousemove = null;
                    };
                    
                    document.onmousemove = (e) => {
                        e = e || window.event;
                        e.preventDefault();
                        
                        pos1 = pos3 - e.clientX;
                        pos2 = pos4 - e.clientY;
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        
                        element.style.top = (element.offsetTop - pos2) + "px";
                        element.style.left = (element.offsetLeft - pos1) + "px";
                    };
                };
                
                // 触摸事件处理（移动端支持）
                handle.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    
                    this.isDragging = true;
                    this.dragStartX = touch.clientX;
                    this.dragStartY = touch.clientY;
                    this.panelStartX = element.offsetLeft;
                    this.panelStartY = element.offsetTop;
                    
                    // 添加拖动状态样式
                    element.style.transition = 'none';
                    handle.style.cursor = 'grabbing';
                }, { passive: false });
                
                handle.addEventListener('touchmove', (e) => {
                    if (!this.isDragging) return;
                    e.preventDefault();
                    
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - this.dragStartX;
                    const deltaY = touch.clientY - this.dragStartY;
                    
                    // 计算新位置
                    let newX = this.panelStartX + deltaX;
                    let newY = this.panelStartY + deltaY;
                    
                    // 限制在视口范围内
                    const maxX = window.innerWidth - element.offsetWidth;
                    const maxY = window.innerHeight - element.offsetHeight;
                    
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));
                    
                    element.style.left = newX + "px";
                    element.style.top = newY + "px";
                }, { passive: false });
                
                handle.addEventListener('touchend', () => {
                    this.isDragging = false;
                    element.style.transition = '';
                    handle.style.cursor = '';
                });
            }
            
            // 设置事件监听
            setupEventListeners() {
                this.domElements.playBtn.addEventListener('click', () => this.startPlayback());
                this.domElements.stopBtn.addEventListener('click', () => this.stopPlayback());
                
                this.domElements.settingsBtn.addEventListener('click', () => {
                    this.domElements.settingsPanel.style.display = 'block';
                    this.domElements.loopPlayback.checked = this.loopPlayback;
                });
                
                this.domElements.closeSettingsBtn.addEventListener('click', () => {
                    this.domElements.settingsPanel.style.display = 'none';
                });
                
                this.domElements.applySettingsBtn.addEventListener('click', () => this.applySettings());
                
                this.domElements.tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.switchTab(btn.dataset.tab);
                    });
                });
                
                // 段落管理事件监听
                this.domElements.addParagraphBtn.addEventListener('click', () => this.addParagraph());
                this.domElements.copyParagraphBtn.addEventListener('click', () => this.copyParagraph());
                this.domElements.deleteParagraphBtn.addEventListener('click', () => this.deleteSelectedParagraph());
                
                // 小节管理事件监听
                this.domElements.addMeasureBtn.addEventListener('click', () => this.addMeasure());
                this.domElements.deleteMeasureBtn.addEventListener('click', () => this.deleteSelectedMeasure());
                
                // 数据管理事件监听
                this.domElements.exportBtn.addEventListener('click', () => this.exportToJson());
                this.domElements.importBtn.addEventListener('click', () => this.importFromJson());
                this.domElements.applyJsonBtn.addEventListener('click', () => {
                    try {
                        const jsonData = JSON.parse(this.domElements.jsonDisplay.value);
                        this.applyJsonData(jsonData);
                    } catch (error) {
                        this.showStatusMessage('JSON格式错误，请检查数据格式', 'error');
                    }
                });
                
                this.domElements.fileInput.addEventListener('change', (e) => this.handleFileImport(e));
                
                this.makeDraggable(this.domElements.settingsPanel, this.domElements.settingsHeader);
                
                // 点击设置面板外部关闭面板
                document.addEventListener('click', (e) => {
                    if (this.domElements.settingsPanel.style.display === 'block' && 
                        !this.domElements.settingsPanel.contains(e.target) && 
                        e.target !== this.domElements.settingsBtn) {
                        this.domElements.settingsPanel.style.display = 'none';
                    }
                });
                
                // 设置段落名称编辑功能
                this.setupParagraphNameEditing();
            }
        }

        // 创建乐谱播放器实例
        const scorePlayer = new ScorePlayer();
    </script>
</body>
</html>


<!--
升级程序
段落名称可以编辑。
-->