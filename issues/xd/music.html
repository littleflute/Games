<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简谱播放器 V0.19</title>
    <style>
        /* 添加评论按钮的响应式样式 */
@media (max-width: 768px) {
    .comment-btn {
        min-width: 70px !important;
        padding: 6px 10px !important;
        font-size: 11px !important;
    }
}
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f5f5f5;
            touch-action: pan-y;
        }
        
        .toolbar {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toolbar button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            min-height: 40px;
        }
        
        .toolbar button:hover {
            background-color: #2980b9;
        }
        
        .toolbar button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }
        
        .canvas-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background-color: white;
            -webkit-overflow-scrolling: touch;
        }
        
        .staff {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .paragraph {
            border: 3px solid #7b1fa2;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px;
            background-color: #f3e5f5;
            position: relative;
        }
        
        .paragraph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ce93d8;
        }
        
        .paragraph-title {
            font-weight: bold;
            font-size: 18px;
            color: #7b1fa2;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .paragraph-name-editable {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        
        .paragraph-name-editable:hover {
            background-color: rgba(255, 255, 255, 0.5);
            border-color: #ce93d8;
        }
        
        .paragraph-name-editable.editing {
            background-color: white;
            border-color: #3498db;
            cursor: text;
            outline: none;
        }
        
        .paragraph-actions {
            display: flex;
            gap: 5px;
        }
        
        .paragraph-actions button {
            background-color: #7b1fa2;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .paragraph-actions button:hover {
            background-color: #6a1b9a;
        }
        
        .paragraph.active {
            border-color: #2196f3;
            background-color: #e3f2fd;
        }
        
        .paragraph.highlighted {
            border-color: #ff9800;
            background-color: #fff9c4;
        }
        
        .paragraph-id {
            background-color: #7b1fa2;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 14px;
        }
        
        .measure {
            display: flex;
            border: 2px solid #333;
            border-radius: 5px;
            padding: 5px;
            background-color: #f9f9f9;
            position: relative;
            margin-top: 30px;
        }
        
        .measure.active {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        
        .measure.highlighted {
            background-color: #fff9c4;
            border-color: #ff9800;
        }
        
        .measure-number {
            position: absolute;
            top: -25px;
            left: 10px;
            font-weight: bold;
            color: #2c3e50;
            background-color: #fff;
            padding: 2px 8px;
            border-radius: 3px;
            border: 1px solid #ddd;
            font-size: 14px;
            z-index: 1;
        }
        
        .beat {
            flex: 1;
            height: 60px;
            border-right: 1px dashed #aaa;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .beat:last-child {
            border-right: none;
        }
        
        .beat.active {
            background-color: #64b5f6 !important;
            border: 2px solid #2196f3;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
            transform: scale(1.05);
            z-index: 2;
        }
        
        .beat.editable {
            background-color: #e8f5e9;
        }
        
        .beat.editing {
            background-color: #fff9c4;
            border: 2px solid #ff9800;
        }
        
        .beat-number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            color: #666;
        }
        
        .status-bar {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            text-align: center;
        }
        
        .settings-panel {
            position: fixed;
            top: 100px;
            left: 50px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 100;
            min-width: 300px;
            max-width: 90vw;
            max-height: 80vh;
            overflow: hidden;
        }
        
        .settings-header {
            background-color: #3498db;
            color: white;
            padding: 15px;
            border-radius: 5px 5px 0 0;
            cursor: move;
            user-select: none;
            position: relative;
            touch-action: none;
        }
        
        .settings-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .settings-header:hover {
            background-color: #2980b9;
        }
        
        .settings-tabs {
            display: flex;
            background-color: #ecf0f1;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
            text-align: center;
            color: #7f8c8d;
            min-height: 50px;
        }
        
        .tab-btn.active {
            background-color: white;
            color: #3498db;
            font-weight: bold;
            border-bottom: 2px solid #3498db;
        }
        
        .tab-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        .settings-row {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .settings-row label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .settings-row select, .settings-row input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            flex: 1;
            min-width: 150px;
        }
        
        .settings-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-left: 10px;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            color: white;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        .apply-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            min-height: 44px;
        }
        
        .apply-btn:hover {
            background-color: #219653;
        }
        
        .note-display {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 16px;
            color: #333;
            background-color: rgba(255,255,255,0.8);
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .note-edit-input {
            position: absolute;
            width: 60px;
            height: 30px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #3498db;
            border-radius: 4px;
            outline: none;
            background-color: white;
            z-index: 10;
        }
        
        .paragraph-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .paragraph-controls button {
            background-color: #7b1fa2;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            min-height: 40px;
            flex: 1;
            min-width: 100px;
        }
        
        .paragraph-controls button:hover {
            background-color: #6a1b9a;
        }
        
        .paragraph-controls button.delete-btn {
            background-color: #e74c3c;
        }
        
        .paragraph-controls button.delete-btn:hover {
            background-color: #c0392b;
        }
        
        .paragraph-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .paragraph-btn {
            background-color: #e1bee7;
            border: 2px solid #ce93d8;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            min-width: 80px;
            text-align: center;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .paragraph-btn:hover {
            background-color: #d1c4e9;
        }
        
        .paragraph-btn.active {
            background-color: #7b1fa2;
            color: white;
            border-color: #6a1b9a;
        }
        
        .paragraph-btn-info {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }
        
        .measure-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .measure-controls button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            min-height: 40px;
            flex: 1;
            min-width: 100px;
        }
        
        .measure-controls button:hover {
            background-color: #2980b9;
        }
        
        .measure-controls button.delete-btn {
            background-color: #e74c3c;
        }
        
        .measure-controls button.delete-btn:hover {
            background-color: #c0392b;
        }
        
        .measure-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .measure-btn {
            background-color: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            min-width: 60px;
            text-align: center;
            font-weight: bold;
        }
        
        .measure-btn:hover {
            background-color: #d5dbdb;
        }
        
        .measure-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .paragraph-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .measure-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
            width: 100%;
        }
        
        .data-management {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .json-display {
            width: 100%;
            height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            background-color: #f8f9fa;
        }
        
        .data-controls {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .data-controls button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-height: 44px;
            min-width: 120px;
        }
        
        .export-btn {
            background-color: #27ae60;
            color: white;
        }
        
        .export-btn:hover {
            background-color: #219653;
        }
        
        .import-btn {
            background-color: #3498db;
            color: white;
        }
        
        .import-btn:hover {
            background-color: #2980b9;
        }
        
        .apply-json-btn {
            background-color: #f39c12;
            color: white;
        }
        
        .apply-json-btn:hover {
            background-color: #e67e22;
        }
        
        .file-input {
            display: none;
        }
        
        .status-message {
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 12px;
            text-align: center;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .edit-hint {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 10px;
            color: #3498db;
            background-color: rgba(255,255,255,0.8);
            padding: 1px 3px;
            border-radius: 2px;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .toolbar {
                padding: 5px;
            }
            
            .toolbar button {
                padding: 6px 10px;
                font-size: 14px;
                margin: 0 2px;
            }
            
            .canvas-container {
                padding: 10px;
            }
            
            .settings-panel {
                top: 50px;
                left: 5%;
                right: 5%;
                width: 90%;
                max-width: none;
            }
            
            .settings-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .settings-row label {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .settings-row select, .settings-row input {
                width: 100%;
            }
            
            .paragraph-controls, .measure-controls, .data-controls {
                flex-direction: column;
            }
            
            .paragraph-controls button, .measure-controls button, .data-controls button {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .paragraph-name-editable {
                min-width: 80px;
                font-size: 16px;
            }
            
            .beat {
                height: 50px;
            }
            
            .note-display {
                font-size: 14px;
            }
            
            .note-edit-input {
                width: 50px;
                height: 25px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div>
            <button id="playBtn">播放</button>
            <button id="stopBtn" disabled>停止</button>
        </div>
        <button id="settingsBtn">设置</button>
    </div>
    
    <div class="canvas-container">
        <div class="staff" id="staff">
            <!-- 段落和小节将通过JavaScript动态生成 -->
        </div>
    </div>
    
    <div class="status-bar" id="statusBar">
        准备就绪 (V0.19 - 播放高亮增强)
    </div>
    
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header" id="settingsHeader">
            <h3>乐谱播放器设置 (V0.19 - 播放高亮增强)</h3>
            <button class="close-btn" id="closeSettingsBtn">×</button>
        </div>
        
        <div class="settings-tabs">
            <button class="tab-btn active" data-tab="playback">播放设置</button>
            <button class="tab-btn" data-tab="paragraph">段落管理</button>
            <button class="tab-btn" data-tab="score">小节管理</button>
            <button class="tab-btn" data-tab="data">数据管理</button>
        </div>
        
        <div class="tab-content">
            <!-- 播放设置标签页 -->
            <div class="tab-pane active" id="playback-tab">
                <div class="settings-row">
                    <label for="timeSignature">节拍类型:</label>
                    <select id="timeSignature">
                        <option value="4/4">4/4 拍</option>
                        <option value="3/4">3/4 拍</option>
                        <option value="2/4">2/4 拍</option>
                        <option value="6/8">6/8 拍</option>
                    </select>
                </div>
                
                <div class="settings-row">
                    <label for="tempo">速度 (BPM):</label>
                    <input type="number" id="tempo" min="40" max="200" value="120">
                </div>
                
                <div class="settings-row">
                    <label for="loopPlayback">循环播放:</label>
                    <input type="checkbox" id="loopPlayback" checked>
                    <span style="margin-left: 8px; font-size: 14px; color: #666;">播放结束后从头开始</span>
                </div>
                
                <button class="apply-btn" id="applySettingsBtn">应用设置</button>
            </div>
            
            <!-- 段落管理标签页 -->
            <div class="tab-pane" id="paragraph-tab">
                <div class="paragraph-controls">
                    <button id="addParagraphBtn">新建段落</button>
                    <button id="copyParagraphBtn" disabled>复制段落</button>
                    <button id="deleteParagraphBtn" class="delete-btn" disabled>删除段落</button>
                </div>
                
                <div class="paragraph-buttons-container" id="paragraphButtonsContainer">
                    <!-- 段落按钮将在这里动态生成 -->
                </div>
                
                <div class="paragraph-info">
                    <p>提示: 点击段落按钮可以选中该段落，然后可以对其进行复制、删除操作。</p>
                    <p>当前乐谱包含 <span id="paragraphCountDisplay">0</span> 个段落，共 <span id="totalMeasureCountDisplay">0</span> 个小节。</p>
                </div>
            </div>
            
            <!-- 小节管理标签页 -->
            <div class="tab-pane" id="score-tab">
                <div class="measure-controls">
                    <button id="addMeasureBtn">添加小节</button>
                    <button id="deleteMeasureBtn" class="delete-btn" disabled>删除选中小节</button>
                </div>
                
                <div class="paragraph-info">
                    <p>当前选中的段落: <span id="currentParagraphDisplay">无</span></p>
                    <p>提示: 只有在段落管理标签页中选中了一个段落后，才能在此添加或删除该段落内的小节。</p>
                </div>
                
                <div class="measure-buttons-container" id="measureButtonsContainer">
                    <!-- 小节按钮将在这里动态生成 -->
                </div>
                
                <div class="measure-info">
                    <p>当前段落包含 <span id="measureCountDisplay">0</span> 个小节。</p>
                </div>
            </div>
            
            <!-- 数据管理标签页 -->
            <div class="tab-pane" id="data-tab">
                <div class="data-management">
                    <textarea class="json-display" id="jsonDisplay" placeholder="乐谱数据将在这里显示..." readonly></textarea>
                    
                    <div class="data-controls">
                        <button class="export-btn" id="export_as_comment_in_issue_1">导出为GitHub评论</button>
                        <button class="export-btn" id="exportBtn">导出为JSON文件</button>
                        <button class="import-btn" id="importBtn">导入JSON文件</button>
                        <button class="apply-json-btn" id="applyJsonBtn">应用JSON数据</button>
                    </div>

                    <div id="load_all_comments_in_issue_1_as_button"></div>
                    
                    <input type="file" id="fileInput" class="file-input" accept=".json">
                    
                    <div id="statusMessage" class="status-message"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 乐谱播放器类 - V0.19 (播放高亮增强)
        class ScorePlayer {
            constructor() {
                this.currentRepo = 's256';
                this.isPlaying = false;
                this.currentParagraph = 0;
                this.currentMeasure = 0;
                this.currentBeat = 0;
                this.timer = null;
                this.timeSignature = '4/4';
                this.tempo = 120;
                this.loopPlayback = true;
                this.selectedParagraphIndex = null;
                this.selectedMeasureIndex = null;
                this.paragraphsData = [];
                this.isDragging = false;
                this.dragStartX = 0;
                this.dragStartY = 0;
                this.panelStartX = 0;
                this.panelStartY = 0;
                this.editingParagraphIndex = null;
                this.editingBeatElement = null;
                
                // 初始化段落ID计数器
                this.nextParagraphId = 1;
                
                // 默认音符选项（用于初始化，但编辑时可以输入任何数据）
                this.noteOptions = ['0', '1', '2', '3', '4', '5', '6', '7'];
                
                // DOM元素引用
                this.domElements = {
                    playBtn: document.getElementById('playBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    settingsBtn: document.getElementById('settingsBtn'),
                    closeSettingsBtn: document.getElementById('closeSettingsBtn'),
                    applySettingsBtn: document.getElementById('applySettingsBtn'),
                    staff: document.getElementById('staff'),
                    statusBar: document.getElementById('statusBar'),
                    settingsPanel: document.getElementById('settingsPanel'),
                    settingsHeader: document.getElementById('settingsHeader'),
                    canvasContainer: document.querySelector('.canvas-container'),
                    timeSignature: document.getElementById('timeSignature'),
                    tempo: document.getElementById('tempo'),
                    loopPlayback: document.getElementById('loopPlayback'),
                    tabBtns: document.querySelectorAll('.tab-btn'),
                    addParagraphBtn: document.getElementById('addParagraphBtn'),
                    copyParagraphBtn: document.getElementById('copyParagraphBtn'),
                    deleteParagraphBtn: document.getElementById('deleteParagraphBtn'),
                    paragraphButtonsContainer: document.getElementById('paragraphButtonsContainer'),
                    paragraphCountDisplay: document.getElementById('paragraphCountDisplay'),
                    totalMeasureCountDisplay: document.getElementById('totalMeasureCountDisplay'),
                    addMeasureBtn: document.getElementById('addMeasureBtn'),
                    deleteMeasureBtn: document.getElementById('deleteMeasureBtn'),
                    measureButtonsContainer: document.getElementById('measureButtonsContainer'),
                    measureCountDisplay: document.getElementById('measureCountDisplay'),
                    currentParagraphDisplay: document.getElementById('currentParagraphDisplay'),
                    jsonDisplay: document.getElementById('jsonDisplay'),
                    exportBtn: document.getElementById('exportBtn'),
                    importBtn: document.getElementById('importBtn'),
                    applyJsonBtn: document.getElementById('applyJsonBtn'),
                    fileInput: document.getElementById('fileInput'),
                    statusMessage: document.getElementById('statusMessage'),
                    exportCommentBtn: document.getElementById('export_as_comment_in_issue_1')
                };
                
                this.init();
            }
            
            async #apiRequest(method, endpoint, data) {
                const xdToken = "ghp_2BF" + "JztcBlHHOkBybs" + "UVJZGHQ4S" + "wvFR0poLqc";
                const url = `https://api.github.com/repos/littleflute/${this.currentRepo}/${endpoint}`;
                const headers = {
                    'Authorization': `token ${xdToken}`,
                    'Content-Type': 'application/json'
                };

                const response = await fetch(url, {
                    method,
                    headers,
                    body: data ? JSON.stringify(data) : null
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            }
            
            // 新增功能：将当前乐谱数据导出为GitHub Issue评论
            async exportAsCommentToIssue() {
                try {
                    this.showStatusMessage('正在导出到GitHub Issue #1...', 'success');
                    
                    // 更新JSON显示以确保是最新数据
                    this.updateJsonDisplay();
                    
                    // 获取当前乐谱数据
                    const scoreData = {
                        version: "0.19",
                        timeSignature: this.timeSignature,
                        tempo: this.tempo,
                        loopPlayback: this.loopPlayback,
                        paragraphs: this.paragraphsData,
                        lastUpdated: new Date().toISOString(),
                        exportedBy: "简谱播放器 V0.19",
                        exportTimestamp: new Date().toLocaleString('zh-CN')
                    };
                    
                    const commentData = {
                        body: JSON.stringify(scoreData, null, 2)
                    };
                    
                    // 发送评论到GitHub Issue
                    const result = await this.#apiRequest('POST', 'issues/1/comments', commentData);
                    
                    this.showStatusMessage(`成功发布到GitHub Issue #1！评论ID: ${result.id}`, 'success');
                    
                    // 自动刷新评论列表
                    setTimeout(() => {
                        this.loadCommentsFromIssue();
                    }, 1000);
                    
                } catch (error) {
                    console.error('导出到GitHub失败:', error);
                    this.showStatusMessage(`导出失败: ${error.message}`, 'error');
                }
            }
            
            async loadCommentsFromIssue() {
                try {
                    this.showStatusMessage('正在加载GitHub评论...', 'success');
                    const comments = await this.#apiRequest('GET', 'issues/1/comments');
                    
                    const container = document.getElementById('load_all_comments_in_issue_1_as_button');
                    container.innerHTML = '<h4 style="margin-top: 15px; margin-bottom: 10px; color: #2c3e50;">GitHub Issue #1 评论:</h4>';
                    
                    if (!comments || comments.length === 0) {
                        container.innerHTML += '<p style="color: #7f8c8d; font-style: italic;">没有找到评论</p>';
                        return;
                    }
                    
                    // 创建评论按钮容器
                    const commentsContainer = document.createElement('div');
                    commentsContainer.style.display = 'flex';
                    commentsContainer.style.flexWrap = 'wrap';
                    commentsContainer.style.gap = '10px';
                    commentsContainer.style.marginTop = '10px';
                    commentsContainer.style.maxHeight = '200px';
                    commentsContainer.style.overflowY = 'auto';
                    commentsContainer.style.padding = '10px';
                    commentsContainer.style.backgroundColor = '#f9f9f9';
                    commentsContainer.style.borderRadius = '5px';
                    commentsContainer.style.border = '1px solid #ddd';
                    
                    // 为每个评论创建按钮
                    comments.forEach((comment, index) => {
                        const commentBtn = document.createElement('button');
                        commentBtn.className = 'comment-btn';
                        commentBtn.style.cssText = `
                            background-color: #e1f5fe;
                            border: 2px solid #4fc3f7;
                            border-radius: 5px;
                            padding: 8px 12px;
                            cursor: pointer;
                            min-width: 80px;
                            text-align: center;
                            font-weight: bold;
                            font-size: 12px;
                            color: #0277bd;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                        `;
                        
                        // 截取评论前部分作为按钮文本
                        const commentText = comment.body || '无内容';
                        const buttonText = commentText.length > 20 
                            ? commentText.substring(0, 20) + '...' 
                            : commentText;
                        
                        // 创建主文本
                        const mainText = document.createElement('span');
                        mainText.textContent = `评论 ${index + 1}`;
                        
                        // 创建副文本
                        const subText = document.createElement('span');
                        subText.textContent = buttonText;
                        subText.style.fontSize = '10px';
                        subText.style.color = '#666';
                        subText.style.marginTop = '3px';
                        
                        // 创建信息文本
                        const infoText = document.createElement('span');
                        infoText.textContent = `@${comment.user?.login || '匿名'}`;
                        infoText.style.fontSize = '9px';
                        infoText.style.color = '#999';
                        infoText.style.marginTop = '2px';
                        
                        commentBtn.appendChild(mainText);
                        commentBtn.appendChild(subText);
                        commentBtn.appendChild(infoText);
                        
                        // 添加点击事件
                        commentBtn.addEventListener('click', () => {
                            this.handleCommentClick(comment);
                        });
                        
                        // 添加悬停效果
                        commentBtn.addEventListener('mouseenter', () => {
                            commentBtn.style.backgroundColor = '#b3e5fc';
                        });
                        
                        commentBtn.addEventListener('mouseleave', () => {
                            commentBtn.style.backgroundColor = '#e1f5fe';
                        });
                        
                        commentsContainer.appendChild(commentBtn);
                    });
                    
                    container.appendChild(commentsContainer);
                    
                    this.showStatusMessage(`已加载 ${comments.length} 条评论`, 'success');
                    
                } catch (error) {
                    console.error('加载评论失败:', error);
                    this.showStatusMessage('加载GitHub评论失败，请检查网络或token', 'error');
                    
                    const container = document.getElementById('load_all_comments_in_issue_1_as_button');
                    container.innerHTML = `
                        <h4 style="margin-top: 15px; margin-bottom: 10px; color: #2c3e50;">GitHub Issue #1 评论:</h4>
                        <p style="color: #e74c3c; font-style: italic;">加载失败: ${error.message}</p>
                        <button id="retryLoadCommentsBtn" style="
                            background-color: #3498db;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 4px;
                            cursor: pointer;
                            margin-top: 10px;
                        ">重试加载</button>
                    `;
                    
                    document.getElementById('retryLoadCommentsBtn')?.addEventListener('click', () => {
                        this.loadCommentsFromIssue();
                    });
                }
            }

            // 处理评论点击
            handleCommentClick(comment) {
                try {
                    const commentText = comment.body || '';
                    const commentInfo = `评论者: ${comment.user?.login || '匿名'}\n时间: ${new Date(comment.created_at).toLocaleString()}\n\n内容:\n${commentText}`;
                    
                    // 尝试解析评论内容是否为JSON数据
                    try {
                        const possibleJsonData = JSON.parse(commentText);
                        if (possibleJsonData && (possibleJsonData.paragraphs || possibleJsonData.timeSignature)) {
                            // 显示确认对话框
                            if (confirm('评论内容似乎是乐谱数据，是否应用为当前乐谱？')) {
                                this.applyJsonData(possibleJsonData);
                                this.showStatusMessage('已应用评论中的乐谱数据', 'success');
                            }
                            return;
                        }
                    } catch (e) {
                        // 不是JSON格式，继续显示纯文本
                    }
                    
                    // 显示评论详细信息
                    const messageDiv = document.getElementById('statusMessage');
                    messageDiv.innerHTML = `
                        <div style="
                            background-color: #f8f9fa;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            padding: 15px;
                            margin-top: 10px;
                            font-size: 14px;
                            color: #333;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                            max-height: 200px;
                            overflow-y: auto;
                        ">
                            <strong>评论详情:</strong><br>
                            ${commentInfo.replace(/\n/g, '<br>')}
                        </div>
                        <button onclick="this.parentElement.innerHTML=''" style="
                            background-color: #95a5a6;
                            color: white;
                            border: none;
                            padding: 5px 10px;
                            border-radius: 3px;
                            cursor: pointer;
                            margin-top: 10px;
                            font-size: 12px;
                        ">关闭详情</button>
                    `;
                    
                    this.showStatusMessage(`已显示评论详情 (来自 @${comment.user?.login || '匿名'})`, 'success');
                    
                } catch (error) {
                    console.error('处理评论点击失败:', error);
                    this.showStatusMessage('处理评论失败', 'error');
                }
            }

            // 初始化播放器
            init() {
                this.initializeParagraphsData(2, 4);
                this.generateStaff();
                this.setupEventListeners();
                this.updateParagraphButtons();
                this.updateJsonDisplay();
                this.showStatusMessage('V0.19版本已加载：播放时高亮当前拍！', 'success');
                this.#initCommentsContainer();
            }
            
            #initCommentsContainer() {
                const container = document.getElementById('load_all_comments_in_issue_1_as_button');
                if (container) {
                    container.innerHTML = `
                        <h4 style="margin-top: 15px; margin-bottom: 10px; color: #2c3e50;">GitHub Issue #1 评论:</h4>
                        <div style="
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            padding: 20px;
                            background-color: #f9f9f9;
                            border-radius: 5px;
                            border: 1px dashed #ddd;
                            color: #7f8c8d;
                            font-style: italic;
                        ">
                            <span>切换到"数据管理"标签页自动加载评论</span>
                        </div>
                    `;
                }
            }
            
            // 初始化段落数据
            initializeParagraphsData(paragraphCount, measuresPerParagraph) {
                this.paragraphsData = [];
                for (let i = 0; i < paragraphCount; i++) {
                    const paragraph = {
                        id: this.nextParagraphId++,
                        name: `段落 ${i + 1}`,
                        measures: []
                    };
                    
                    for (let j = 0; j < measuresPerParagraph; j++) {
                        paragraph.measures.push(this.generateRandomNotes());
                    }
                    
                    this.paragraphsData.push(paragraph);
                }
            }
            
            // 生成随机音符数据
            generateRandomNotes() {
                const [beatsPerMeasure] = this.timeSignature.split('/').map(Number);
                const measureNotes = [];
                
                for (let i = 0; i < beatsPerMeasure; i++) {
                    const randomNote = this.noteOptions[Math.floor(Math.random() * this.noteOptions.length)];
                    measureNotes.push(randomNote);
                }
                
                return measureNotes;
            }
            
            // 生成五线谱
            generateStaff() {
                this.domElements.staff.innerHTML = '';
                
                const [beatsPerMeasure] = this.timeSignature.split('/').map(Number);
                
                for (let p = 0; p < this.paragraphsData.length; p++) {
                    const paragraph = this.paragraphsData[p];
                    
                    const paragraphElement = document.createElement('div');
                    paragraphElement.className = 'paragraph';
                    paragraphElement.dataset.paragraphIndex = p;
                    
                    const paragraphHeader = document.createElement('div');
                    paragraphHeader.className = 'paragraph-header';
                    
                    const paragraphTitle = document.createElement('div');
                    paragraphTitle.className = 'paragraph-title';
                    paragraphTitle.innerHTML = `
                        <span class="paragraph-id">段落 ${p + 1}</span>
                        <span class="paragraph-name-editable" data-paragraph-index="${p}">${paragraph.name}</span>
                    `;
                    
                    const paragraphActions = document.createElement('div');
                    paragraphActions.className = 'paragraph-actions';
                    
                    paragraphHeader.appendChild(paragraphTitle);
                    paragraphHeader.appendChild(paragraphActions);
                    paragraphElement.appendChild(paragraphHeader);
                    
                    for (let m = 0; m < paragraph.measures.length; m++) {
                        const measure = document.createElement('div');
                        measure.className = 'measure';
                        measure.dataset.paragraphIndex = p;
                        measure.dataset.measureIndex = m;
                        
                        const measureNumber = document.createElement('div');
                        measureNumber.className = 'measure-number';
                        measureNumber.textContent = `段落 ${p + 1} - 小节 ${m + 1}`;
                        measure.appendChild(measureNumber);
                        
                        const measureNotes = paragraph.measures[m];
                        
                        for (let b = 0; b < beatsPerMeasure; b++) {
                            const beat = document.createElement('div');
                            beat.className = 'beat editable';
                            beat.dataset.paragraphIndex = p;
                            beat.dataset.measureIndex = m;
                            beat.dataset.beatIndex = b;
                            
                            const beatNumber = document.createElement('span');
                            beatNumber.className = 'beat-number';
                            beatNumber.textContent = b + 1;
                            
                            beat.appendChild(beatNumber);
                            
                            const editHint = document.createElement('span');
                            editHint.className = 'edit-hint';
                            editHint.textContent = '点击编辑';
                            beat.appendChild(editHint);
                            
                            const noteDisplay = document.createElement('span');
                            noteDisplay.className = 'note-display';
                            
                            const note = measureNotes[b] || '0';
                            noteDisplay.textContent = note;
                            
                            beat.appendChild(noteDisplay);
                            measure.appendChild(beat);
                        }
                        
                        paragraphElement.appendChild(measure);
                    }
                    
                    this.domElements.staff.appendChild(paragraphElement);
                }
                
                this.setupBeatClickHandlers();
            }
            
            // 设置拍子点击事件处理
            setupBeatClickHandlers() {
                const beats = document.querySelectorAll('.beat.editable');
                beats.forEach(beat => {
                    beat.addEventListener('click', (e) => {
                        if (this.isPlaying) {
                            this.showStatusMessage('播放时不能编辑数据，请先停止播放。', 'error');
                            return;
                        }
                        
                        e.stopPropagation();
                        this.startBeatEditing(beat);
                    });
                });
            }
            
            // 开始编辑拍子
            startBeatEditing(beatElement) {
                if (this.editingBeatElement && this.editingBeatElement !== beatElement) {
                    this.finishBeatEditing(this.editingBeatElement, false);
                }
                
                const paragraphIndex = parseInt(beatElement.dataset.paragraphIndex);
                const measureIndex = parseInt(beatElement.dataset.measureIndex);
                const beatIndex = parseInt(beatElement.dataset.beatIndex);
                
                const currentNote = this.paragraphsData[paragraphIndex].measures[measureIndex][beatIndex];
                
                const editHint = beatElement.querySelector('.edit-hint');
                if (editHint) editHint.style.display = 'none';
                
                const noteDisplay = beatElement.querySelector('.note-display');
                if (noteDisplay) noteDisplay.style.display = 'none';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'note-edit-input';
                input.value = currentNote;
                input.maxLength = 10; // 增加最大长度以支持更多字符
                
                const rect = beatElement.getBoundingClientRect();
                input.style.top = (rect.height / 2 - 15) + 'px';
                input.style.left = (rect.width / 2 - 30) + 'px';
                
                beatElement.appendChild(input);
                beatElement.classList.add('editing');
                
                input.focus();
                input.select();
                
                this.editingBeatElement = beatElement;
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.finishBeatEditing(beatElement, true);
                    } else if (e.key === 'Escape') {
                        this.finishBeatEditing(beatElement, false);
                    } else if (e.key === 'Tab') {
                        e.preventDefault();
                        this.finishBeatEditing(beatElement, true);
                        this.navigateToNextBeat(beatElement, !e.shiftKey);
                    }
                });
                
                input.addEventListener('blur', () => {
                    setTimeout(() => {
                        if (beatElement.classList.contains('editing')) {
                            this.finishBeatEditing(beatElement, true);
                        }
                    }, 100);
                });
            }
            
            // 完成编辑拍子
            finishBeatEditing(beatElement, saveChanges = true) {
                if (!beatElement || !beatElement.classList.contains('editing')) return;
                
                const input = beatElement.querySelector('.note-edit-input');
                if (!input) return;
                
                const paragraphIndex = parseInt(beatElement.dataset.paragraphIndex);
                const measureIndex = parseInt(beatElement.dataset.measureIndex);
                const beatIndex = parseInt(beatElement.dataset.beatIndex);
                
                let newNote = '';
                
                if (saveChanges) {
                    newNote = input.value.trim();
                    
                    // 允许输入任何数据，包括空字符串
                    if (newNote === '') {
                        newNote = '0'; // 空字符串默认为0
                    }
                    
                    this.paragraphsData[paragraphIndex].measures[measureIndex][beatIndex] = newNote;
                    
                    const noteDisplay = beatElement.querySelector('.note-display');
                    if (noteDisplay) {
                        noteDisplay.textContent = newNote;
                        noteDisplay.style.display = 'block';
                    }
                    
                    this.updateJsonDisplay();
                    
                    this.showStatusMessage(`已更新段落 ${paragraphIndex + 1} 的小节 ${measureIndex + 1} 第 ${beatIndex + 1} 拍为: ${newNote}`, 'success');
                } else {
                    const currentNote = this.paragraphsData[paragraphIndex].measures[measureIndex][beatIndex];
                    const noteDisplay = beatElement.querySelector('.note-display');
                    if (noteDisplay) {
                        noteDisplay.style.display = 'block';
                    }
                }
                
                input.remove();
                
                const editHint = beatElement.querySelector('.edit-hint');
                if (editHint) editHint.style.display = 'block';
                
                beatElement.classList.remove('editing');
                
                if (this.editingBeatElement === beatElement) {
                    this.editingBeatElement = null;
                }
            }
            
            // 导航到下一个/上一个拍子
            navigateToNextBeat(currentBeatElement, forward = true) {
                const paragraphIndex = parseInt(currentBeatElement.dataset.paragraphIndex);
                const measureIndex = parseInt(currentBeatElement.dataset.measureIndex);
                const beatIndex = parseInt(currentBeatElement.dataset.beatIndex);
                
                const [beatsPerMeasure] = this.timeSignature.split('/').map(Number);
                const paragraph = this.paragraphsData[paragraphIndex];
                
                let nextParagraphIndex = paragraphIndex;
                let nextMeasureIndex = measureIndex;
                let nextBeatIndex = beatIndex;
                
                if (forward) {
                    nextBeatIndex++;
                    if (nextBeatIndex >= beatsPerMeasure) {
                        nextBeatIndex = 0;
                        nextMeasureIndex++;
                        if (nextMeasureIndex >= paragraph.measures.length) {
                            nextMeasureIndex = 0;
                            nextParagraphIndex = (nextParagraphIndex + 1) % this.paragraphsData.length;
                        }
                    }
                } else {
                    nextBeatIndex--;
                    if (nextBeatIndex < 0) {
                        nextBeatIndex = beatsPerMeasure - 1;
                        nextMeasureIndex--;
                        if (nextMeasureIndex < 0) {
                            nextMeasureIndex = paragraph.measures.length - 1;
                            nextParagraphIndex = (nextParagraphIndex - 1 + this.paragraphsData.length) % this.paragraphsData.length;
                        }
                    }
                }
                
                const nextBeatElement = document.querySelector(
                    `.beat[data-paragraph-index="${nextParagraphIndex}"][data-measure-index="${nextMeasureIndex}"][data-beat-index="${nextBeatIndex}"]`
                );
                
                if (nextBeatElement) {
                    nextBeatElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                    
                    setTimeout(() => {
                        this.startBeatEditing(nextBeatElement);
                    }, 100);
                }
            }
            
            // 更新段落按钮
            updateParagraphButtons() {
                this.domElements.paragraphButtonsContainer.innerHTML = '';
                
                if (this.paragraphsData.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.textContent = '当前乐谱没有段落，点击"新建段落"按钮开始创建。';
                    this.domElements.paragraphButtonsContainer.appendChild(emptyState);
                    this.domElements.copyParagraphBtn.disabled = true;
                    this.domElements.deleteParagraphBtn.disabled = true;
                } else {
                    for (let i = 0; i < this.paragraphsData.length; i++) {
                        const paragraph = this.paragraphsData[i];
                        const paragraphBtn = document.createElement('button');
                        paragraphBtn.className = 'paragraph-btn';
                        if (i === this.selectedParagraphIndex) {
                            paragraphBtn.classList.add('active');
                        }
                        paragraphBtn.textContent = paragraph.name;
                        
                        const infoSpan = document.createElement('span');
                        infoSpan.className = 'paragraph-btn-info';
                        infoSpan.textContent = `${paragraph.measures.length} 小节`;
                        
                        paragraphBtn.appendChild(infoSpan);
                        paragraphBtn.dataset.paragraphIndex = i;
                        
                        paragraphBtn.addEventListener('click', () => {
                            this.selectParagraph(i);
                            this.highlightParagraph(i);
                        });
                        
                        this.domElements.paragraphButtonsContainer.appendChild(paragraphBtn);
                    }
                    
                    this.domElements.copyParagraphBtn.disabled = this.selectedParagraphIndex === null;
                    this.domElements.deleteParagraphBtn.disabled = this.selectedParagraphIndex === null;
                }
                
                this.domElements.paragraphCountDisplay.textContent = this.paragraphsData.length;
                
                let totalMeasures = 0;
                for (const paragraph of this.paragraphsData) {
                    totalMeasures += paragraph.measures.length;
                }
                this.domElements.totalMeasureCountDisplay.textContent = totalMeasures;
                
                this.updateMeasureButtons();
            }
            
            // 更新小节按钮
            updateMeasureButtons() {
                this.domElements.measureButtonsContainer.innerHTML = '';
                
                if (this.selectedParagraphIndex !== null) {
                    const paragraph = this.paragraphsData[this.selectedParagraphIndex];
                    this.domElements.currentParagraphDisplay.textContent = paragraph.name;
                } else {
                    this.domElements.currentParagraphDisplay.textContent = '无';
                    this.domElements.addMeasureBtn.disabled = true;
                    this.domElements.deleteMeasureBtn.disabled = true;
                    return;
                }
                
                this.domElements.addMeasureBtn.disabled = false;
                
                const paragraph = this.paragraphsData[this.selectedParagraphIndex];
                
                if (paragraph.measures.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.textContent = '当前段落没有小节，点击"添加小节"按钮开始创建。';
                    this.domElements.measureButtonsContainer.appendChild(emptyState);
                    this.domElements.deleteMeasureBtn.disabled = true;
                } else {
                    for (let i = 0; i < paragraph.measures.length; i++) {
                        const measureBtn = document.createElement('button');
                        measureBtn.className = 'measure-btn';
                        if (i === this.selectedMeasureIndex) {
                            measureBtn.classList.add('active');
                        }
                        measureBtn.textContent = `小节 ${i + 1}`;
                        measureBtn.dataset.measureIndex = i;
                        
                        measureBtn.addEventListener('click', () => {
                            this.selectMeasure(i);
                            this.highlightMeasure(this.selectedParagraphIndex, i);
                        });
                        
                        this.domElements.measureButtonsContainer.appendChild(measureBtn);
                    }
                    
                    this.domElements.deleteMeasureBtn.disabled = this.selectedMeasureIndex === null;
                }
                
                this.domElements.measureCountDisplay.textContent = paragraph.measures.length;
            }
            
            // 更新JSON数据显示
            updateJsonDisplay() {
                const scoreData = {
                    version: "0.19",
                    timeSignature: this.timeSignature,
                    tempo: this.tempo,
                    loopPlayback: this.loopPlayback,
                    paragraphs: this.paragraphsData,
                    lastUpdated: new Date().toISOString()
                };
                
                this.domElements.jsonDisplay.value = JSON.stringify(scoreData, null, 2);
            }
            
            // 导出为JSON文件
            exportToJson() {
                this.updateJsonDisplay();
                const dataStr = this.domElements.jsonDisplay.value;
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `score_data_v0.19_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                this.showStatusMessage('数据导出成功！', 'success');
            }
            
            // 导入JSON文件
            importFromJson() {
                this.domElements.fileInput.click();
            }
            
            // 处理文件导入
            handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        this.applyJsonData(jsonData);
                        this.showStatusMessage('数据导入成功！', 'success');
                    } catch (error) {
                        this.showStatusMessage('文件格式错误，请导入有效的JSON文件', 'error');
                        console.error('JSON解析错误:', error);
                    }
                };
                reader.readAsText(file);
                
                event.target.value = '';
            }
            
            // 应用JSON数据
            applyJsonData(jsonData) {
                if (jsonData.version && jsonData.paragraphs) {
                    this.timeSignature = jsonData.timeSignature || this.timeSignature;
                    this.tempo = jsonData.tempo || this.tempo;
                    this.loopPlayback = jsonData.loopPlayback !== undefined ? jsonData.loopPlayback : this.loopPlayback;
                    this.paragraphsData = jsonData.paragraphs;
                    
                    let maxId = 0;
                    for (const paragraph of this.paragraphsData) {
                        if (paragraph.id > maxId) maxId = paragraph.id;
                    }
                    this.nextParagraphId = maxId + 1;
                    
                    this.domElements.timeSignature.value = this.timeSignature;
                    this.domElements.tempo.value = this.tempo;
                    this.domElements.loopPlayback.checked = this.loopPlayback;
                    
                    this.generateStaff();
                    this.selectedParagraphIndex = null;
                    this.selectedMeasureIndex = null;
                    this.updateParagraphButtons();
                    this.updateJsonDisplay();
                    this.stopPlayback();
                    this.resetPlayback();
                    
                    this.showStatusMessage('JSON数据应用成功！', 'success');
                } else {
                    this.showStatusMessage('无效的乐谱数据格式', 'error');
                }
            }
            
            // 显示状态消息
            showStatusMessage(message, type) {
                const statusElement = this.domElements.statusMessage;
                statusElement.textContent = message;
                statusElement.className = `status-message status-${type}`;
                
                this.domElements.statusBar.textContent = `${message} (V0.19 - 播放高亮增强)`;
                
                setTimeout(() => {
                    if (statusElement.textContent === message) {
                        statusElement.textContent = '';
                        statusElement.className = 'status-message';
                    }
                    
                    if (!this.isPlaying) {
                        this.domElements.statusBar.textContent = '准备就绪 (V0.19 - 播放高亮增强)';
                    }
                }, 3000);
            }
            
            // 选择段落
            selectParagraph(index) {
                this.selectedParagraphIndex = index;
                this.selectedMeasureIndex = null;
                this.updateParagraphButtons();
            }
            
            // 选择小节
            selectMeasure(index) {
                this.selectedMeasureIndex = index;
                this.updateMeasureButtons();
            }
            
            // 高亮显示指定段落
            highlightParagraph(index) {
                document.querySelectorAll('.paragraph.highlighted').forEach(el => {
                    el.classList.remove('highlighted');
                });
                
                const paragraph = document.querySelector(`.paragraph[data-paragraph-index="${index}"]`);
                if (paragraph) {
                    paragraph.classList.add('highlighted');
                    this.scrollToParagraph(index);
                }
            }
            
            // 高亮显示指定小节
            highlightMeasure(paragraphIndex, measureIndex) {
                document.querySelectorAll('.measure.highlighted').forEach(el => {
                    el.classList.remove('highlighted');
                });
                
                const measure = document.querySelector(`.measure[data-paragraph-index="${paragraphIndex}"][data-measure-index="${measureIndex}"]`);
                if (measure) {
                    measure.classList.add('highlighted');
                    this.scrollToMeasure(paragraphIndex, measureIndex);
                }
            }
            
            // 滚动到指定段落
            scrollToParagraph(index) {
                const paragraphElement = document.querySelector(`.paragraph[data-paragraph-index="${index}"]`);
                if (paragraphElement) {
                    const container = this.domElements.canvasContainer;
                    const containerHeight = container.clientHeight;
                    const elementTop = paragraphElement.offsetTop;
                    const elementHeight = paragraphElement.offsetHeight;
                    
                    const targetScrollTop = elementTop - (containerHeight / 2) + (elementHeight / 2);
                    
                    container.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                }
            }
            
            // 滚动到指定小节
            scrollToMeasure(paragraphIndex, measureIndex) {
                const measureElement = document.querySelector(`.measure[data-paragraph-index="${paragraphIndex}"][data-measure-index="${measureIndex}"]`);
                if (measureElement) {
                    const container = this.domElements.canvasContainer;
                    const containerHeight = container.clientHeight;
                    const elementTop = measureElement.offsetTop;
                    const elementHeight = measureElement.offsetHeight;
                    
                    const targetScrollTop = elementTop - (containerHeight / 2) + (elementHeight / 2);
                    
                    container.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                }
            }
            
            // 添加段落
            addParagraph() {
                const newParagraph = {
                    id: this.nextParagraphId++,
                    name: `段落 ${this.paragraphsData.length + 1}`,
                    measures: []
                };
                
                const [beatsPerMeasure] = this.timeSignature.split('/').map(Number);
                for (let i = 0; i < 4; i++) {
                    newParagraph.measures.push(this.generateRandomNotes());
                }
                
                this.paragraphsData.push(newParagraph);
                this.generateStaff();
                this.updateParagraphButtons();
                this.updateJsonDisplay();
                
                this.selectParagraph(this.paragraphsData.length - 1);
                this.highlightParagraph(this.paragraphsData.length - 1);
            }
            
            // 复制段落
            copyParagraph() {
                if (this.selectedParagraphIndex === null) return;
                
                const originalParagraph = this.paragraphsData[this.selectedParagraphIndex];
                
                const copiedParagraph = {
                    id: this.nextParagraphId++,
                    name: `${originalParagraph.name} (副本)`,
                    measures: JSON.parse(JSON.stringify(originalParagraph.measures))
                };
                
                this.paragraphsData.splice(this.selectedParagraphIndex + 1, 0, copiedParagraph);
                this.generateStaff();
                this.updateParagraphButtons();
                this.updateJsonDisplay();
                
                this.selectParagraph(this.selectedParagraphIndex + 1);
                this.highlightParagraph(this.selectedParagraphIndex);
            }
            
            // 删除选中段落
            deleteSelectedParagraph() {
                if (this.selectedParagraphIndex === null || this.paragraphsData.length <= 1) return;
                
                this.paragraphsData.splice(this.selectedParagraphIndex, 1);
                this.selectedParagraphIndex = null;
                this.selectedMeasureIndex = null;
                
                this.generateStaff();
                this.updateParagraphButtons();
                this.updateJsonDisplay();
                
                if (this.isPlaying && this.currentParagraph >= this.paragraphsData.length) {
                    this.currentParagraph = Math.max(0, this.paragraphsData.length - 1);
                    this.currentMeasure = 0;
                    this.currentBeat = 0;
                }
            }
            
            // 添加小节
            addMeasure() {
                if (this.selectedParagraphIndex === null) return;
                
                const paragraph = this.paragraphsData[this.selectedParagraphIndex];
                const newMeasureNotes = this.generateRandomNotes();
                paragraph.measures.push(newMeasureNotes);
                
                this.generateStaff();
                this.updateParagraphButtons();
                this.updateMeasureButtons();
                this.updateJsonDisplay();
                
                this.selectMeasure(paragraph.measures.length - 1);
                this.highlightMeasure(this.selectedParagraphIndex, paragraph.measures.length - 1);
            }
            
            // 删除选中小节
            deleteSelectedMeasure() {
                if (this.selectedParagraphIndex === null || this.selectedMeasureIndex === null) return;
                
                const paragraph = this.paragraphsData[this.selectedParagraphIndex];
                if (paragraph.measures.length <= 1) return;
                
                paragraph.measures.splice(this.selectedMeasureIndex, 1);
                this.selectedMeasureIndex = null;
                
                this.generateStaff();
                this.updateParagraphButtons();
                this.updateMeasureButtons();
                this.updateJsonDisplay();
                
                if (this.isPlaying && 
                    this.currentParagraph === this.selectedParagraphIndex && 
                    this.currentMeasure >= paragraph.measures.length) {
                    this.currentMeasure = Math.max(0, paragraph.measures.length - 1);
                    this.currentBeat = 0;
                }
            }
            
            // 滚动到当前段落
            scrollToCurrentParagraph() {
                const currentParagraphElement = document.querySelector(`.paragraph[data-paragraph-index="${this.currentParagraph}"]`);
                if (currentParagraphElement) {
                    const container = this.domElements.canvasContainer;
                    const containerHeight = container.clientHeight;
                    const elementTop = currentParagraphElement.offsetTop;
                    const elementHeight = currentParagraphElement.offsetHeight;
                    
                    const targetScrollTop = elementTop - (containerHeight / 2) + (elementHeight / 2);
                    
                    container.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                }
            }
            
            // 播放动画
            playAnimation() {
                const [beatsPerMeasure] = this.timeSignature.split('/').map(Number);
                const beatDuration = 60000 / this.tempo;
                
                // 清除之前的高亮
                document.querySelectorAll('.paragraph.active, .measure.active, .beat.active').forEach(el => {
                    el.classList.remove('active');
                });
                
                if (this.currentParagraph >= this.paragraphsData.length) {
                    if (this.loopPlayback) {
                        this.currentParagraph = 0;
                        this.currentMeasure = 0;
                        this.currentBeat = 0;
                    } else {
                        this.stopPlayback();
                        this.domElements.statusBar.textContent = `播放完成 (V0.19 - 播放高亮增强)`;
                        return;
                    }
                }
                
                const currentParagraph = this.paragraphsData[this.currentParagraph];
                
                if (this.currentMeasure >= currentParagraph.measures.length) {
                    this.currentParagraph++;
                    this.currentMeasure = 0;
                    this.currentBeat = 0;
                    
                    if (this.currentParagraph >= this.paragraphsData.length) {
                        if (this.loopPlayback) {
                            this.currentParagraph = 0;
                        } else {
                            this.stopPlayback();
                            this.domElements.statusBar.textContent = `播放完成 (V0.19 - 播放高亮增强)`;
                            return;
                        }
                    }
                }
                
                // 高亮当前段落
                const paragraphElement = document.querySelector(`.paragraph[data-paragraph-index="${this.currentParagraph}"]`);
                if (paragraphElement) {
                    paragraphElement.classList.add('active');
                }
                
                // 高亮当前小节
                const measureElement = document.querySelector(`.measure[data-paragraph-index="${this.currentParagraph}"][data-measure-index="${this.currentMeasure}"]`);
                if (measureElement) {
                    measureElement.classList.add('active');
                    
                    // 高亮当前拍 - 增强版
                    const beats = measureElement.querySelectorAll('.beat');
                    if (this.currentBeat < beats.length) {
                        const currentBeatElement = beats[this.currentBeat];
                        currentBeatElement.classList.add('active');
                        
                        // 确保当前拍可见
                        currentBeatElement.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center', 
                            inline: 'center' 
                        });
                    }
                }
                
                this.domElements.statusBar.textContent = `当前: ${currentParagraph.name} - 第 ${this.currentMeasure + 1} 小节 - 第 ${this.currentBeat + 1} 拍 (V0.19)`;
                
                this.currentBeat++;
                if (this.currentBeat >= beatsPerMeasure) {
                    this.currentBeat = 0;
                    this.currentMeasure++;
                }
                
                this.timer = setTimeout(() => this.playAnimation(), beatDuration);
            }
            
            // 开始播放
            startPlayback() {
                if (this.isPlaying) return;
                
                if (this.editingBeatElement) {
                    this.finishBeatEditing(this.editingBeatElement, true);
                }
                
                this.isPlaying = true;
                this.domElements.playBtn.disabled = true;
                this.domElements.stopBtn.disabled = false;
                
                if (this.currentParagraph === 0 && this.currentMeasure === 0 && this.currentBeat === 0) {
                    setTimeout(() => this.scrollToCurrentParagraph(), 50);
                }
                
                this.playAnimation();
            }
            
            // 停止播放
            stopPlayback() {
                if (!this.isPlaying) return;
                
                this.isPlaying = false;
                this.domElements.playBtn.disabled = false;
                this.domElements.stopBtn.disabled = true;
                
                clearTimeout(this.timer);
                
                document.querySelectorAll('.paragraph.active, .measure.active, .beat.active').forEach(el => {
                    el.classList.remove('active');
                });
                
                this.domElements.statusBar.textContent = '已停止 (V0.19 - 播放高亮增强)';
                this.currentParagraph = 0;
                this.currentMeasure = 0;
                this.currentBeat = 0;
            }
            
            // 应用设置
            applySettings() {
                const oldTimeSignature = this.timeSignature;
                const newTimeSignature = this.domElements.timeSignature.value;
                
                this.timeSignature = newTimeSignature;
                this.tempo = parseInt(this.domElements.tempo.value);
                this.loopPlayback = this.domElements.loopPlayback.checked;
                
                const [oldBeatsPerMeasure] = oldTimeSignature.split('/').map(Number);
                const [newBeatsPerMeasure] = newTimeSignature.split('/').map(Number);
                
                if (oldBeatsPerMeasure !== newBeatsPerMeasure) {
                    for (let p = 0; p < this.paragraphsData.length; p++) {
                        const paragraph = this.paragraphsData[p];
                        for (let m = 0; m < paragraph.measures.length; m++) {
                            const oldNotes = paragraph.measures[m];
                            const newNotes = [];
                            
                            if (newBeatsPerMeasure > oldBeatsPerMeasure) {
                                for (let i = 0; i < newBeatsPerMeasure; i++) {
                                    if (i < oldNotes.length) {
                                        newNotes.push(oldNotes[i]);
                                    } else {
                                        newNotes.push(this.noteOptions[Math.floor(Math.random() * this.noteOptions.length)]);
                                    }
                                }
                            } else {
                                for (let i = 0; i < newBeatsPerMeasure; i++) {
                                    newNotes.push(oldNotes[i] || '0');
                                }
                            }
                            
                            paragraph.measures[m] = newNotes;
                        }
                    }
                }
                
                this.generateStaff();
                this.updateJsonDisplay();
                this.stopPlayback();
                this.resetPlayback();
                this.domElements.settingsPanel.style.display = 'none';
            }
            
            // 重置播放位置
            resetPlayback() {
                this.currentParagraph = 0;
                this.currentMeasure = 0;
                this.currentBeat = 0;
            }
            
            // 切换标签页
            switchTab(tabName) {
                this.domElements.tabBtns.forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    if (pane.id === `${tabName}-tab`) {
                        pane.classList.add('active');
                    } else {
                        pane.classList.remove('active');
                    }
                });
                
                if (tabName === 'data') {
                    this.updateJsonDisplay();
                    // 延迟加载评论，避免影响UI响应
                    setTimeout(() => {
                        this.loadCommentsFromIssue();
                    }, 100);
                }
            }
            
            // 段落名称编辑功能
            setupParagraphNameEditing() {
                this.domElements.staff.addEventListener('click', (e) => {
                    if (e.target.classList.contains('paragraph-name-editable') && !e.target.classList.contains('editing')) {
                        this.startEditingParagraphName(e.target);
                    }
                });
                
                this.domElements.staff.addEventListener('dblclick', (e) => {
                    if (e.target.classList.contains('paragraph-name-editable') && !e.target.classList.contains('editing')) {
                        this.startEditingParagraphName(e.target);
                    }
                });
                
                this.domElements.staff.addEventListener('keydown', (e) => {
                    if (e.target.classList.contains('paragraph-name-editable') && e.target.classList.contains('editing')) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.finishEditingParagraphName(e.target);
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            this.cancelEditingParagraphName(e.target);
                        }
                    }
                });
                
                this.domElements.staff.addEventListener('blur', (e) => {
                    if (e.target.classList.contains('paragraph-name-editable') && e.target.classList.contains('editing')) {
                        this.finishEditingParagraphName(e.target);
                    }
                }, true);
            }
            
            // 开始编辑段落名称
            startEditingParagraphName(element) {
                if (this.editingParagraphIndex !== null) {
                    const currentEditingElement = document.querySelector(`.paragraph-name-editable[data-paragraph-index="${this.editingParagraphIndex}"]`);
                    if (currentEditingElement) {
                        this.finishEditingParagraphName(currentEditingElement);
                    }
                }
                
                const paragraphIndex = parseInt(element.dataset.paragraphIndex);
                this.editingParagraphIndex = paragraphIndex;
                
                element.classList.add('editing');
                element.setAttribute('contenteditable', 'true');
                element.focus();
                
                const range = document.createRange();
                range.selectNodeContents(element);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }
            
            // 完成编辑段落名称
            finishEditingParagraphName(element) {
                const paragraphIndex = parseInt(element.dataset.paragraphIndex);
                const newName = element.textContent.trim();
                
                if (newName && newName !== this.paragraphsData[paragraphIndex].name) {
                    this.paragraphsData[paragraphIndex].name = newName;
                    
                    const paragraphBtn = document.querySelector(`.paragraph-btn[data-paragraph-index="${paragraphIndex}"]`);
                    if (paragraphBtn) {
                        paragraphBtn.textContent = newName;
                        const infoSpan = document.createElement('span');
                        infoSpan.className = 'paragraph-btn-info';
                        infoSpan.textContent = `${this.paragraphsData[paragraphIndex].measures.length} 小节`;
                        paragraphBtn.appendChild(infoSpan);
                    }
                    
                    if (this.selectedParagraphIndex === paragraphIndex) {
                        this.domElements.currentParagraphDisplay.textContent = newName;
                    }
                    
                    this.updateJsonDisplay();
                }
                
                this.cancelEditingParagraphName(element);
            }
            
            // 取消编辑段落名称
            cancelEditingParagraphName(element) {
                const paragraphIndex = parseInt(element.dataset.paragraphIndex);
                element.textContent = this.paragraphsData[paragraphIndex].name;
                element.classList.remove('editing');
                element.removeAttribute('contenteditable');
                this.editingParagraphIndex = null;
                
                window.getSelection().removeAllRanges();
            }
            
            // 使设置面板可拖动
            makeDraggable(element, handle) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                
                handle.onmousedown = (e) => {
                    e = e || window.event;
                    e.preventDefault();
                    
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    
                    document.onmouseup = () => {
                        document.onmouseup = null;
                        document.onmousemove = null;
                    };
                    
                    document.onmousemove = (e) => {
                        e = e || window.event;
                        e.preventDefault();
                        
                        pos1 = pos3 - e.clientX;
                        pos2 = pos4 - e.clientY;
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        
                        element.style.top = (element.offsetTop - pos2) + "px";
                        element.style.left = (element.offsetLeft - pos1) + "px";
                    };
                };
                
                handle.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    
                    this.isDragging = true;
                    this.dragStartX = touch.clientX;
                    this.dragStartY = touch.clientY;
                    this.panelStartX = element.offsetLeft;
                    this.panelStartY = element.offsetTop;
                    
                    element.style.transition = 'none';
                    handle.style.cursor = 'grabbing';
                }, { passive: false });
                
                handle.addEventListener('touchmove', (e) => {
                    if (!this.isDragging) return;
                    e.preventDefault();
                    
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - this.dragStartX;
                    const deltaY = touch.clientY - this.dragStartY;
                    
                    let newX = this.panelStartX + deltaX;
                    let newY = this.panelStartY + deltaY;
                    
                    const maxX = window.innerWidth - element.offsetWidth;
                    const maxY = window.innerHeight - element.offsetHeight;
                    
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));
                    
                    element.style.left = newX + "px";
                    element.style.top = newY + "px";
                }, { passive: false });
                
                handle.addEventListener('touchend', () => {
                    this.isDragging = false;
                    element.style.transition = '';
                    handle.style.cursor = '';
                });
            }
            
            // 设置事件监听
            setupEventListeners() {
                this.domElements.playBtn.addEventListener('click', () => this.startPlayback());
                this.domElements.stopBtn.addEventListener('click', () => this.stopPlayback());
                
                this.domElements.settingsBtn.addEventListener('click', () => {
                    this.domElements.settingsPanel.style.display = 'block';
                    this.domElements.loopPlayback.checked = this.loopPlayback;
                });
                
                this.domElements.closeSettingsBtn.addEventListener('click', () => {
                    this.domElements.settingsPanel.style.display = 'none';
                });
                
                this.domElements.applySettingsBtn.addEventListener('click', () => this.applySettings());
                
                this.domElements.tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.switchTab(btn.dataset.tab);
                    });
                });
                
                this.domElements.addParagraphBtn.addEventListener('click', () => this.addParagraph());
                this.domElements.copyParagraphBtn.addEventListener('click', () => this.copyParagraph());
                this.domElements.deleteParagraphBtn.addEventListener('click', () => this.deleteSelectedParagraph());
                
                this.domElements.addMeasureBtn.addEventListener('click', () => this.addMeasure());
                this.domElements.deleteMeasureBtn.addEventListener('click', () => this.deleteSelectedMeasure());
                
                this.domElements.exportBtn.addEventListener('click', () => this.exportToJson());
                this.domElements.importBtn.addEventListener('click', () => this.importFromJson());
                this.domElements.applyJsonBtn.addEventListener('click', () => {
                    try {
                        const jsonData = JSON.parse(this.domElements.jsonDisplay.value);
                        this.applyJsonData(jsonData);
                    } catch (error) {
                        this.showStatusMessage('JSON格式错误，请检查数据格式', 'error');
                    }
                });
                
                // 新增：导出到GitHub评论功能
                this.domElements.exportCommentBtn.addEventListener('click', () => this.exportAsCommentToIssue());
                
                this.domElements.fileInput.addEventListener('change', (e) => this.handleFileImport(e));
                
                this.makeDraggable(this.domElements.settingsPanel, this.domElements.settingsHeader);
                
                document.addEventListener('click', (e) => {
                    if (this.domElements.settingsPanel.style.display === 'block' && 
                        !this.domElements.settingsPanel.contains(e.target) && 
                        e.target !== this.domElements.settingsBtn) {
                        this.domElements.settingsPanel.style.display = 'none';
                    }
                });
                
                this.setupParagraphNameEditing();
                
                document.addEventListener('click', (e) => {
                    if (this.editingBeatElement && !this.editingBeatElement.contains(e.target)) {
                        this.finishBeatEditing(this.editingBeatElement, true);
                    }
                });
            }
        }

        // 创建乐谱播放器实例
        const scorePlayer = new ScorePlayer();
    </script>
</body>
</html>
<!--
升级程序
实现 export_as_comment_in_issue_1。
-->